name: CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]

env:
  NODE_VERSION: '18'

jobs:
  # =====================================================
  # Lint - Validate JavaScript syntax
  # =====================================================
  lint:
    name: Lint JavaScript
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint JavaScript files
        run: |
          # Check JavaScript syntax using Node.js
          echo "Checking JavaScript syntax..."
          find www/js -name "*.js" -type f | while read file; do
            node --check "$file" 2>&1 || echo "Syntax error in: $file"
          done
          echo "JavaScript syntax check completed"

  # =====================================================
  # Security - Check for secrets in code
  # =====================================================
  security:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."

          # Patterns to check (these should NOT appear in frontend code)
          PATTERNS=(
            "sk_live_"
            "sk_test_"
            "whsec_"
            "STRIPE_SECRET"
            "service_role"
            "supabase_service"
          )

          FOUND_SECRETS=0

          for pattern in "${PATTERNS[@]}"; do
            if grep -r "$pattern" www/ --include="*.js" --include="*.html" 2>/dev/null; then
              echo "⚠️ Found potential secret pattern: $pattern"
              FOUND_SECRETS=1
            fi
          done

          if [ $FOUND_SECRETS -eq 1 ]; then
            echo "❌ Security check failed: Potential secrets found in code"
            exit 1
          else
            echo "✅ No secrets found in frontend code"
          fi

  # =====================================================
  # Build - Test Android build
  # =====================================================
  build-android:
    name: Build Android (Debug)
    runs-on: ubuntu-latest
    needs: [lint, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Capacitor Sync
        run: npx cap sync android

      - name: Build Debug APK
        working-directory: ./android
        run: ./gradlew assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7

  # =====================================================
  # Validate - Run system validation
  # =====================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Supabase config exists
        run: |
          if [ ! -f "www/js/core/supabase-config.js" ]; then
            echo "❌ supabase-config.js not found"
            exit 1
          fi
          echo "✅ supabase-config.js exists"

      - name: Validate Edge Functions
        run: |
          FUNCTIONS=("create-checkout-session" "stripe-webhook" "send-email")

          for fn in "${FUNCTIONS[@]}"; do
            if [ ! -f "supabase/functions/$fn/index.ts" ]; then
              echo "⚠️ Edge function $fn not found"
            else
              echo "✅ Edge function $fn exists"
            fi
          done

      - name: Validate migrations
        run: |
          if [ -d "supabase/migrations" ]; then
            echo "Migrations found:"
            ls -la supabase/migrations/
          else
            echo "⚠️ No migrations directory found"
          fi

  # =====================================================
  # Deploy Edge Functions (manual trigger)
  # =====================================================
  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "⚠️ Supabase secrets not configured, skipping deploy"
            exit 0
          fi

          echo "Deploying Edge Functions..."
          supabase functions deploy create-checkout-session --project-ref $SUPABASE_PROJECT_ID
          supabase functions deploy stripe-webhook --project-ref $SUPABASE_PROJECT_ID
          supabase functions deploy send-email --project-ref $SUPABASE_PROJECT_ID
          echo "✅ Edge Functions deployed"

  # =====================================================
  # Summary
  # =====================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, security, validate]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
