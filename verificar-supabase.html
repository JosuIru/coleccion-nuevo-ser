<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Estado Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-slate-800 rounded-2xl p-8 mb-8 shadow-2xl border border-blue-500/20">
            <h1 class="text-4xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                üîç Verificar Estado Supabase
            </h1>
            <p class="text-slate-300 text-lg mb-4">
                Esta herramienta verifica qu√© tablas existen y su estructura actual
            </p>

            <!-- Auth Status -->
            <div id="auth-status" class="mb-4 p-4 bg-slate-700 rounded-lg">
                <p class="text-sm text-slate-300">Verificando sesi√≥n...</p>
            </div>

            <!-- Login Form (hidden by default) -->
            <div id="login-form" class="hidden mb-4 space-y-3">
                <p class="text-yellow-300 text-sm mb-2">
                    ‚ö†Ô∏è No hay sesi√≥n activa. Inicia sesi√≥n para verificar las tablas:
                </p>
                <input type="email" id="email-input" placeholder="tu-email@ejemplo.com"
                       class="w-full bg-slate-700 text-white px-4 py-2 rounded border border-slate-600 focus:border-blue-500 outline-none">
                <input type="password" id="password-input" placeholder="Contrase√±a"
                       class="w-full bg-slate-700 text-white px-4 py-2 rounded border border-slate-600 focus:border-blue-500 outline-none">
                <button id="login-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    üîê Iniciar Sesi√≥n
                </button>
                <p class="text-xs text-slate-400">
                    Usa las mismas credenciales que en la aplicaci√≥n principal
                </p>
            </div>

            <button id="check-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                üîé Verificar Ahora
            </button>
        </div>

        <div id="results" class="hidden">
            <div class="bg-slate-800 rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üìä Resultados</h2>
                <div id="status" class="space-y-4"></div>
            </div>

            <div id="recommendations" class="bg-yellow-900/50 border-2 border-yellow-500 rounded-xl p-6">
                <h2 class="text-xl font-bold mb-3">üí° Recomendaci√≥n</h2>
                <div id="recommendation-text"></div>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400"></div>
            <p class="mt-4 text-slate-300">Verificando...</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://flxrilsxghiqfsfifxch.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZseHJpbHN4Z2hpcWZzZmlmeGNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODUzMDQsImV4cCI6MjA4MDI2MTMwNH0.Q-loU9hZybMoFr4SrIvnCyhZPOmsYdRAqnJnyIvUdV4';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                storageKey: 'verificador-supabase-auth'
            }
        });

        const REQUIRED_TABLES = [
            'profiles',
            'reading_progress',
            'notes',
            'achievements',
            'bookmarks',
            'user_settings',
            'reflections',
            'action_plans',
            'koan_history'
        ];

        // Check authentication on load
        (async () => {
            const { data: { session } } = await supabase.auth.getSession();
            updateAuthUI(session);
        })();

        function updateAuthUI(session) {
            const authStatus = document.getElementById('auth-status');
            const loginForm = document.getElementById('login-form');
            const checkBtn = document.getElementById('check-btn');

            if (session) {
                authStatus.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-green-400 font-semibold">‚úÖ Sesi√≥n Activa</p>
                            <p class="text-xs text-slate-400 mt-1">${session.user.email}</p>
                        </div>
                        <button id="logout-btn" class="text-xs text-red-400 hover:text-red-300">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                `;
                loginForm.classList.add('hidden');
                checkBtn.disabled = false;

                // Logout handler
                document.getElementById('logout-btn')?.addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    updateAuthUI(null);
                });
            } else {
                authStatus.innerHTML = `
                    <p class="text-sm text-yellow-400">‚ö†Ô∏è No hay sesi√≥n activa</p>
                `;
                loginForm.classList.remove('hidden');
                checkBtn.disabled = true;
            }
        }

        // Login handler
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const loginBtn = document.getElementById('login-btn');

            if (!email || !password) {
                alert('Por favor ingresa email y contrase√±a');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '‚è≥ Iniciando sesi√≥n...';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                updateAuthUI(data.session);
                alert('‚úÖ Sesi√≥n iniciada correctamente');
            } catch (error) {
                alert('‚ùå Error al iniciar sesi√≥n: ' + error.message);
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'üîê Iniciar Sesi√≥n';
            }
        });

        // Check button handler
        document.getElementById('check-btn').addEventListener('click', async () => {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            await checkSupabase();

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
        });

        async function checkSupabase() {
            const statusDiv = document.getElementById('status');
            const recommendationDiv = document.getElementById('recommendation-text');
            statusDiv.innerHTML = '';

            let missingTables = [];
            let errorTables = [];
            let successTables = [];

            // Check authentication
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                statusDiv.innerHTML += `
                    <div class="bg-red-900/50 border border-red-500 rounded p-4">
                        <h3 class="font-bold mb-2">‚ùå No Autenticado</h3>
                        <p class="text-sm">Debes iniciar sesi√≥n primero en la aplicaci√≥n principal</p>
                    </div>
                `;
                recommendationDiv.innerHTML = `
                    <p class="mb-2">Primero debes autenticarte:</p>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>Abre la aplicaci√≥n principal</li>
                        <li>Inicia sesi√≥n con tu cuenta</li>
                        <li>Vuelve aqu√≠ y haz clic en "Verificar Ahora"</li>
                    </ol>
                `;
                return;
            }

            statusDiv.innerHTML += `
                <div class="bg-green-900/50 border border-green-500 rounded p-4 mb-4">
                    <h3 class="font-bold mb-2">‚úÖ Autenticado</h3>
                    <p class="text-sm">Usuario: ${session.user.email}</p>
                    <p class="text-xs text-slate-400 mt-1">UID: ${session.user.id}</p>
                </div>
            `;

            // Check each table
            for (const table of REQUIRED_TABLES) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);

                    if (error) {
                        if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
                            missingTables.push(table);
                            statusDiv.innerHTML += `
                                <div class="bg-red-900/30 border border-red-700 rounded p-3">
                                    <span class="font-mono text-sm">‚ùå ${table}</span>
                                    <span class="text-xs text-red-300 ml-2">NO EXISTE</span>
                                </div>
                            `;
                        } else if (error.code === '42501') {
                            errorTables.push({ table, error: 'RLS policy error' });
                            statusDiv.innerHTML += `
                                <div class="bg-yellow-900/30 border border-yellow-700 rounded p-3">
                                    <span class="font-mono text-sm">‚ö†Ô∏è ${table}</span>
                                    <span class="text-xs text-yellow-300 ml-2">EXISTE - ERROR RLS</span>
                                    <p class="text-xs text-slate-400 mt-1">${error.message}</p>
                                </div>
                            `;
                        } else {
                            errorTables.push({ table, error: error.message });
                            statusDiv.innerHTML += `
                                <div class="bg-orange-900/30 border border-orange-700 rounded p-3">
                                    <span class="font-mono text-sm">‚ö†Ô∏è ${table}</span>
                                    <span class="text-xs text-orange-300 ml-2">ERROR: ${error.code || 'unknown'}</span>
                                    <p class="text-xs text-slate-400 mt-1">${error.message}</p>
                                </div>
                            `;
                        }
                    } else {
                        successTables.push(table);
                        statusDiv.innerHTML += `
                            <div class="bg-green-900/30 border border-green-700 rounded p-3">
                                <span class="font-mono text-sm">‚úÖ ${table}</span>
                                <span class="text-xs text-green-300 ml-2">OK</span>
                            </div>
                        `;
                    }
                } catch (err) {
                    errorTables.push({ table, error: err.message });
                    statusDiv.innerHTML += `
                        <div class="bg-red-900/30 border border-red-700 rounded p-3">
                            <span class="font-mono text-sm">‚ùå ${table}</span>
                            <span class="text-xs text-red-300 ml-2">EXCEPTION</span>
                            <p class="text-xs text-slate-400 mt-1">${err.message}</p>
                        </div>
                    `;
                }
            }

            // Summary
            statusDiv.innerHTML += `
                <div class="bg-slate-700 rounded p-4 mt-6">
                    <h3 class="font-bold mb-2">üìà Resumen</h3>
                    <div class="grid grid-cols-3 gap-4 text-center text-sm">
                        <div>
                            <div class="text-2xl font-bold text-green-400">${successTables.length}</div>
                            <div class="text-slate-400">OK</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-yellow-400">${errorTables.length}</div>
                            <div class="text-slate-400">Errores</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-400">${missingTables.length}</div>
                            <div class="text-slate-400">Faltantes</div>
                        </div>
                    </div>
                </div>
            `;

            // Recommendations
            if (missingTables.length > 0) {
                recommendationDiv.innerHTML = `
                    <p class="font-bold mb-2">üö® Faltan ${missingTables.length} tablas</p>
                    <p class="mb-3">Las siguientes tablas NO existen: ${missingTables.join(', ')}</p>
                    <p class="mb-2"><strong>Soluci√≥n:</strong></p>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>Abre <code class="bg-slate-700 px-2 py-1 rounded">setup-supabase.html</code></li>
                        <li>Copia el script SQL completo</li>
                        <li>Ve al SQL Editor de Supabase y ejec√∫talo</li>
                        <li>Vuelve aqu√≠ y verifica de nuevo</li>
                    </ol>
                `;
            } else if (errorTables.length > 0) {
                recommendationDiv.innerHTML = `
                    <p class="font-bold mb-2">‚ö†Ô∏è Todas las tablas existen pero hay ${errorTables.length} con errores</p>
                    <p class="mb-3">Probablemente el schema es diferente al esperado o hay problemas con RLS</p>
                    <p class="mb-2"><strong>Soluci√≥n:</strong></p>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li><strong>Opci√≥n 1 (Recomendada):</strong> Re-ejecutar el script SQL desde <code class="bg-slate-700 px-2 py-1 rounded">setup-supabase.html</code> - El script usa <code>CREATE TABLE IF NOT EXISTS</code> y <code>DROP POLICY IF EXISTS</code>, as√≠ que es seguro</li>
                        <li><strong>Opci√≥n 2:</strong> Borrar las tablas con errores manualmente en Supabase y ejecutar el script</li>
                        <li><strong>Opci√≥n 3:</strong> Revisar los logs de Supabase para ver qu√© pol√≠tica RLS est√° bloqueando</li>
                    </ol>
                `;
            } else {
                recommendationDiv.innerHTML = `
                    <p class="font-bold mb-2 text-green-400">üéâ ¬°Todo est√° correcto!</p>
                    <p class="mb-2">Todas las ${successTables.length} tablas existen y son accesibles.</p>
                    <p class="text-sm">Si sigues viendo errores en la aplicaci√≥n, recarga la p√°gina con <kbd class="bg-slate-700 px-2 py-1 rounded">Ctrl+Shift+R</kbd></p>
                `;
            }
        }
    </script>
</body>
</html>
