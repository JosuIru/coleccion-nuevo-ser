<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e1f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Laboratorio Frankenstein - Crea Seres Transformadores con PropÃ³sito">

    <title>Laboratorio Frankenstein</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§¬</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"
            crossorigin="anonymous"
            onerror="document.head.appendChild(Object.assign(document.createElement('link'),{rel:'stylesheet',href:'css/tailwind-fallback.css'}))"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lab-dark': '#0a0e1f',
                        'lab-accent': '#00d4ff',
                        'lab-gold': '#f59e0b'
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Frankenstein CSS -->
    <link rel="stylesheet" href="css/frankenstein-base.css">
    <link rel="stylesheet" href="css/frankenstein-lab.css">
    <link rel="stylesheet" href="css/frankenstein-components.css">
    <link rel="stylesheet" href="css/frankenstein-quiz.css">
    <link rel="stylesheet" href="css/frankenstein-vitruvian.css">
    <link rel="stylesheet" href="css/frankenstein-animations.css">
    <!-- UX Improvements v1.0 -->
    <link rel="stylesheet" href="css/frankenstein-ux-improvements.css">
    <!-- Settings & UI Components -->
    <link rel="stylesheet" href="css/frankenstein-settings.css">
    <!-- Awakening Protocol Theme (nuevo diseÃ±o) -->
    <link rel="stylesheet" href="css/awakening-theme.css">

    <style>
        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #0a0e1f;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #app {
            width: 100%;
            height: 100%;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            overflow-y: auto;
            overflow-x: hidden;
        }

        #organism-container { margin-top: var(--safe-area-top); }

        /* Loading */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0a0e1f 0%, #1a1f3a 50%, #0a0e1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        #loading-screen.fade-out { opacity: 0; pointer-events: none; }
        .loading-icon { font-size: 80px; animation: pulse 2s ease-in-out infinite; }
        .loading-title { color: #f59e0b; font-size: 24px; font-weight: bold; margin-top: 20px; }
        .loading-subtitle { color: #94a3b8; font-size: 14px; margin-top: 8px; }
        .loading-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 30px; overflow: hidden; }
        .loading-progress { height: 100%; background: linear-gradient(90deg, #00d4ff, #f59e0b); animation: loading 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes loading { 0% { width: 0; } 50% { width: 70%; } 100% { width: 100%; } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(20px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(30, 41, 59, 0.95);
            color: white;
            border-radius: 12px;
            font-size: 14px;
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
        }
        .toast.success { background: rgba(16, 185, 129, 0.95); }
        .toast.error { background: rgba(239, 68, 68, 0.95); }
        @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* Android download banner */
        .android-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-top: 1px solid rgba(16, 185, 129, 0.3);
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-area-bottom));
            z-index: 999;
        }
        .android-banner.show { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .android-banner-text { color: #94a3b8; font-size: 13px; flex: 1; }
        .android-banner-text strong { color: white; }
        .android-banner-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            white-space: nowrap;
        }
        .android-banner-close {
            background: none;
            border: none;
            color: #64748b;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[10000] focus:px-4 focus:py-2 focus:bg-amber-400 focus:text-black focus:rounded-lg focus:font-semibold">
        Saltar al contenido principal
    </a>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-icon">ðŸ§¬</div>
        <div class="loading-title">Laboratorio Frankenstein</div>
        <div class="loading-subtitle">Cargando sistema de creaciÃ³n...</div>
        <div class="loading-bar"><div class="loading-progress"></div></div>
    </div>

    <!-- Main Content -->
    <main id="main-content" role="main">
        <div id="organism-container"></div>
    </main>

    <!-- Android Download Banner -->
    <div class="android-banner" id="android-banner">
        <button class="android-banner-close" onclick="document.getElementById('android-banner').classList.remove('show')">Ã—</button>
        <div class="android-banner-text">
            <strong>ðŸ“± Mejor experiencia</strong><br>
            Descarga la app nativa (3.8MB)
        </div>
        <a href="downloads/frankenstein-lab-v1.2.7.apk" class="android-banner-btn" download>Descargar</a>
    </div>

    <!-- Core Scripts -->
    <script src="js/core/logger.js"></script>
    <script src="js/core/icons.js"></script>
    <script src="js/core/i18n.js"></script>

    <!-- Enhanced UI System (Toasts, Tooltips, Bottom Sheets) -->
    <script src="js/core/enhanced-ui-system.js"></script>

    <!-- AI Chat System -->
    <script src="js/ai/ai-config.js"></script>
    <script src="js/ai/ai-adapter.js"></script>
    <script src="js/features/ai-chat-modal.js"></script>

    <!-- Settings, Header & Stats -->
    <script src="js/features/frankenstein-settings.js"></script>

    <!-- Frankenstein Lab Scripts -->
    <script src="js/features/frankenstein-missions.js"></script>
    <script src="js/features/frankenstein-being-card.js"></script>
    <script src="js/features/frankenstein-quiz.js"></script>
    <script src="js/features/frankenstein-audio.js"></script>
    <script src="js/features/frankenstein-avatar-system.js"></script>
    <script src="js/features/frankenstein-tooltips.js"></script>
    <script src="js/features/vitruvian-being.js"></script>
    <script src="js/features/frankenstein-demo-data.js"></script>
    <script src="js/features/frankenstein-microsocieties.js"></script>
    <!-- Microsocieties Extended System -->
    <script src="js/features/microsocieties-avatars.js"></script>
    <script src="js/features/microsocieties-events.js"></script>
    <script src="js/features/microsocieties-events-modal.js"></script>
    <script src="js/features/microsocieties-save-system.js"></script>
    <script src="js/features/microsocieties-progression.js"></script>
    <script src="js/features/microsocieties-story-mode.js"></script>
    <script src="js/features/microsocieties-sandbox.js"></script>
    <script src="js/features/microsocieties-interventions.js"></script>
    <script src="js/features/microsocieties-init.js"></script>
    <script src="js/features/frankenstein-challenges.js"></script>
    <script src="js/features/frankenstein-challenges-modal.js"></script>
    <script src="js/features/frankenstein-rewards.js"></script>
    <script src="js/features/frankenstein-onboarding.js"></script>
    <script src="js/features/frankenstein-ui.js"></script>

    <script>
        // =====================================================
        // FRANKENSTEIN AUDIO SYSTEM - INITIALIZATION
        // =====================================================
        window.frankenAudio = new FrankensteinAudioSystem();

        // Inicializar cuando el DOM estÃ© listo
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[FrankenAudio] ðŸ”Š Inicializando sistema de audio...');

            try {
                // Inicializar contexto de audio
                await window.frankenAudio.init();

                // Iniciar si estÃ¡ habilitado en settings
                if (window.frankenAudio.enabled) {
                    window.frankenAudio.start();
                    console.log('[FrankenAudio] âœ… Sistema de audio iniciado (enabled=true)');
                } else {
                    console.log('[FrankenAudio] â„¹ï¸ Sistema de audio listo pero deshabilitado (enabled=false)');
                }

                // Log del volumen actual
                console.log(`[FrankenAudio] ðŸ”Š Volumen maestro: ${Math.round(window.frankenAudio.masterVolume * 100)}%`);
            } catch (error) {
                console.error('[FrankenAudio] âŒ Error inicializando:', error);
            }
        });

        // =====================================================
        // DEVICE DETECTION & UI
        // =====================================================
        const isAndroid = /Android/i.test(navigator.userAgent);

        // Show Android-specific UI
        if (isAndroid) {
            // Show banner after 3 seconds
            setTimeout(() => {
                document.getElementById('android-banner').classList.add('show');
            }, 3000);
        }

        // Toast
        window.showToast = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // Load book catalog and chapters
        async function loadBookCatalog() {
            try {
                const catalogRes = await fetch('books/catalog.json');
                const catalogData = await catalogRes.json();

                // Load each book's full data
                const booksWithChapters = [];
                for (const book of catalogData.books) {
                    try {
                        const bookRes = await fetch(`books/${book.id}/book.json`);
                        if (bookRes.ok) {
                            const bookData = await bookRes.json();
                            booksWithChapters.push({
                                ...book,
                                fullData: bookData
                            });
                        } else {
                            booksWithChapters.push(book);
                        }
                    } catch (e) {
                        booksWithChapters.push(book);
                    }
                }

                return { ...catalogData, books: booksWithChapters };
            } catch (error) {
                console.error('Error loading catalog:', error);
                return null;
            }
        }

        class LabAIEngineProxy {
            constructor() {
                this.currentBook = 'laboratorio-frankenstein';
                this.currentChapter = 'ser-activo';
                this.currentBookData = {
                    id: 'laboratorio-frankenstein',
                    title: 'Laboratorio Frankenstein',
                    authors: ['ColecciÃ³n Nuevo Ser']
                };
                const basePrompt = this.buildPrompt(null, null);
                this.currentBookConfig = {
                    features: {
                        aiChat: {
                            systemPrompt: basePrompt,
                            modes: {
                                default: { name: 'Ser Activo', systemPrompt: basePrompt },
                                mentor: { name: 'Mentor', systemPrompt: 'ActÃºa como guÃ­a del laboratorio y ofrece orientaciÃ³n estratÃ©gica.' }
                            }
                        }
                    }
                };
            }

            buildPrompt(being, mission) {
                if (!being) {
                    return 'Eres un guÃ­a del Laboratorio Frankenstein. Responde con lenguaje claro, enfocado en misiones y piezas de conocimiento de la colecciÃ³n.';
                }

                const attrMap = window.frankensteinLabUI?.missionsSystem?.attributes || {};
                const attributeEntries = Object.entries(being.attributes || {}).sort((a, b) => b[1] - a[1]);
                const attributeLines = attributeEntries.map(([key, value]) => {
                    const attr = attrMap[key];
                    return `- ${attr?.icon || 'ðŸ“Š'} ${attr?.name || key}: ${Math.round(value)}`;
                }).join('\n');

                const balance = being.balance ? `
Balance:
- Intelectual: ${Math.round(being.balance.intellectual || 0)}
- Emocional: ${Math.round(being.balance.emotional || 0)}
- AcciÃ³n: ${Math.round(being.balance.action || 0)}
- Espiritual: ${Math.round(being.balance.spiritual || 0)}
- PrÃ¡ctico: ${Math.round(being.balance.practical || 0)}
- ArmonÃ­a: ${Math.round(being.balance.harmony || 0)}%` : '';

                const typeLabels = { chapter: 'CapÃ­tulo', exercise: 'Ejercicio', resource: 'Recurso', special: 'Fragmento' };
                const composition = window.frankensteinLabUI?.getCanonicalBeingPieces
                    ? window.frankensteinLabUI.getCanonicalBeingPieces(being)
                    : (being.pieces || []).map(p => ({
                        title: p.title || p.piece?.title || 'Pieza',
                        bookTitle: p.bookTitle || p.piece?.bookTitle || 'ColecciÃ³n',
                        typeLabel: typeLabels[p.type] || 'Pieza',
                        icon: p.icon || 'ðŸ§©',
                        totalPower: Math.round(p.totalPower || 0)
                    }));
                const pieces = composition.map(piece => {
                    return `- ${piece.icon || 'ðŸ§©'} ${piece.title} (${piece.typeLabel} Â· ${piece.bookTitle}) Â· âš¡ ${piece.totalPower || 0}`;
                }).join('\n');

                let prompt = `Eres el Ser "${being.name || 'sin nombre'}" creado en el Laboratorio Frankenstein.`;
                if (mission) {
                    prompt += ` Tu misiÃ³n es "${mission.name}": ${mission.description}.`;
                }

                prompt += `

Atributos clave:
${attributeLines || '- Sin atributos cargados'}
${balance}

Conocimiento base:
${pieces || '- AÃºn no se han seleccionado piezas.'}

Habla como este ser, manteniendo coherencia con su misiÃ³n y atributos.`;

                return prompt;
            }

            updateContext(being, mission) {
                this.currentBeing = being || null;
                this.currentMission = mission || null;
                this.currentBookData.title = being?.name ? `${being.name} Â· Laboratorio Frankenstein` : 'Laboratorio Frankenstein';
                this.currentChapter = mission?.id || 'ser-activo';
                const prompt = this.buildPrompt(being, mission);
                this.currentBookConfig.features.aiChat.systemPrompt = prompt;
                if (this.currentBookConfig.features.aiChat.modes?.default) {
                    this.currentBookConfig.features.aiChat.modes.default.systemPrompt = prompt;
                }
            }

            getCurrentBook() {
                return this.currentBook;
            }

            getCurrentBookData() {
                return this.currentBookData;
            }

            getCurrentBookConfig() {
                return this.currentBookConfig;
            }

            getChapter() {
                return null;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸ§¬ Inicializando Laboratorio Frankenstein...');

            try {
                // Load real book catalog
                const catalog = await loadBookCatalog();
                console.log('ðŸ“š CatÃ¡logo cargado:', catalog?.books?.length || 0, 'libros');

                // Quiz System
                if (typeof FrankensteinQuizSystem !== 'undefined') {
                    window.FrankensteinQuiz = new FrankensteinQuizSystem();
                    window.FrankensteinQuiz.setMode('juego');
                }

                // AI Chat para el laboratorio
                if (typeof AIConfig !== 'undefined' && typeof AIAdapter !== 'undefined' && typeof AIChatModal !== 'undefined') {
                    window.labAIEngineProxy = new LabAIEngineProxy();
                    window.aiConfig = new AIConfig();
                    window.aiAdapter = new AIAdapter(window.aiConfig);
                    window.aiChatModal = new AIChatModal(window.labAIEngineProxy, window.aiAdapter);
                } else {
                    console.warn('AI chat system not available en esta build.');
                }

                // Create organism with real book data
                const organism = {
                    bookEngine: { catalog },
                    getAvailablePieces: () => [],
                    getCurrentBook: () => null,
                    getProgress: () => ({ completedChapters: [], totalChapters: 0 }),
                    getBookChapters: (book) => {
                        if (book.fullData?.sections) {
                            const chapters = [];
                            book.fullData.sections.forEach(s => {
                                if (s.chapters) chapters.push(...s.chapters);
                            });
                            return chapters;
                        }
                        return book.fullData?.chapters || [];
                    },
                    loadChapterMetadata: async (bookId) => {
                        try {
                            const res = await fetch(`books/${bookId}/assets/chapter-metadata.json`);
                            return res.ok ? await res.json() : {};
                        } catch { return {}; }
                    }
                };

                // Lab UI
                if (typeof FrankensteinLabUI !== 'undefined') {
                    window.frankensteinLabUI = new FrankensteinLabUI(organism);
                    await window.frankensteinLabUI.init();
                }

                // Hide loading
                const loading = document.getElementById('loading-screen');
                if (loading) {
                    loading.classList.add('fade-out');
                    setTimeout(() => loading.remove(), 500);
                }

                showToast('Â¡Laboratorio listo!', 'success');

            } catch (error) {
                console.error('Error:', error);
                showToast('Error al cargar', 'error');
            }
        });

        // Lucide icons
        if (window.lucide) lucide.createIcons();
    </script>
</body>
</html>
