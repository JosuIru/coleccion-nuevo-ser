<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Directo Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üî¨ Test Directo - reading_progress</h1>

        <div class="bg-slate-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-bold mb-4">Estado Actual</h2>
            <div id="status" class="space-y-2 text-sm">
                <p>Inicializando...</p>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-bold mb-4">Tests</h2>
            <button id="test-select" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mr-2 mb-2">
                1. Test SELECT
            </button>
            <button id="test-insert" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mr-2 mb-2">
                2. Test INSERT
            </button>
            <button id="test-describe" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded mr-2 mb-2">
                3. Describir Tabla
            </button>
        </div>

        <div class="bg-slate-800 p-6 rounded-lg">
            <h2 class="text-xl font-bold mb-4">Resultados</h2>
            <pre id="results" class="bg-slate-900 p-4 rounded text-xs overflow-x-auto">
Ejecuta un test...
            </pre>
        </div>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://flxrilsxghiqfsfifxch.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZseHJpbHN4Z2hpcWZzZmlmeGNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODUzMDQsImV4cCI6MjA4MDI2MTMwNH0.Q-loU9hZybMoFr4SrIvnCyhZPOmsYdRAqnJnyIvUdV4',
            {
                auth: {
                    persistSession: true,
                    storageKey: 'nuevosser-auth'
                }
            }
        );

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        // Check auth on load
        (async () => {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                statusDiv.innerHTML = `
                    <p class="text-green-400">‚úÖ Autenticado: ${session.user.email}</p>
                    <p class="text-slate-400">UID: ${session.user.id}</p>
                `;
            } else {
                statusDiv.innerHTML = `
                    <p class="text-red-400">‚ùå No autenticado</p>
                    <p class="text-slate-400">Primero inicia sesi√≥n en la app principal</p>
                `;
            }
        })();

        // Test 1: SELECT
        document.getElementById('test-select').addEventListener('click', async () => {
            resultsDiv.textContent = 'Ejecutando SELECT...';

            try {
                const { data, error, status, statusText } = await supabase
                    .from('reading_progress')
                    .select('*')
                    .limit(5);

                resultsDiv.textContent = JSON.stringify({
                    status,
                    statusText,
                    error: error ? {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    } : null,
                    data: data || null,
                    rowCount: data ? data.length : 0
                }, null, 2);
            } catch (err) {
                resultsDiv.textContent = 'EXCEPTION:\n' + JSON.stringify({
                    message: err.message,
                    stack: err.stack
                }, null, 2);
            }
        });

        // Test 2: INSERT
        document.getElementById('test-insert').addEventListener('click', async () => {
            resultsDiv.textContent = 'Ejecutando INSERT...';

            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                resultsDiv.textContent = 'ERROR: No autenticado';
                return;
            }

            try {
                const testData = {
                    user_id: session.user.id,
                    book_id: 'test-' + Date.now(),
                    chapters_read: ['cap1', 'cap2'],
                    total_chapters: 10,
                    progress_percentage: 20,
                    last_chapter_id: 'cap2'
                };

                const { data, error, status, statusText } = await supabase
                    .from('reading_progress')
                    .insert(testData)
                    .select();

                resultsDiv.textContent = JSON.stringify({
                    status,
                    statusText,
                    error: error ? {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    } : null,
                    data: data || null,
                    testData
                }, null, 2);
            } catch (err) {
                resultsDiv.textContent = 'EXCEPTION:\n' + JSON.stringify({
                    message: err.message,
                    stack: err.stack
                }, null, 2);
            }
        });

        // Test 3: Describe table
        document.getElementById('test-describe').addEventListener('click', async () => {
            resultsDiv.textContent = 'Consultando estructura de tabla...';

            try {
                // Hacer un SELECT vac√≠o para obtener estructura
                const { data, error, status, statusText } = await supabase
                    .from('reading_progress')
                    .select('*')
                    .limit(0);

                resultsDiv.textContent = JSON.stringify({
                    status,
                    statusText,
                    error: error ? {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    } : null,
                    info: 'Si status=200, la tabla existe y es accesible',
                    info2: 'Si status=406, hay problema de schema/RLS',
                    info3: 'Si status=404, la tabla no existe'
                }, null, 2);
            } catch (err) {
                resultsDiv.textContent = 'EXCEPTION:\n' + JSON.stringify({
                    message: err.message,
                    stack: err.stack
                }, null, 2);
            }
        });
    </script>
</body>
</html>
