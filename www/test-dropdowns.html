<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Dropdowns - v2.9.317</title>
  <style>
    body {
      font-family: monospace;
      background: #1a1a1a;
      color: #0f0;
      padding: 20px;
    }
    .log {
      background: #000;
      padding: 10px;
      margin: 10px 0;
      border-left: 4px solid #0f0;
    }
    .error {
      border-left-color: #f00;
      color: #f00;
    }
    .success {
      border-left-color: #0f0;
      color: #0f0;
    }
    .warning {
      border-left-color: #ff0;
      color: #ff0;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #0c0;
    }
  </style>
</head>
<body>
  <h1>üß™ Test Autom√°tico de Dropdowns - v2.9.317</h1>
  <div id="controls">
    <button onclick="runTest()">‚ñ∂Ô∏è Ejecutar Test</button>
    <button onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
  </div>
  <div id="logs"></div>

  <script>
    const logs = document.getElementById('logs');

    function log(message, type = 'log') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logs.appendChild(div);
      console.log(message);
    }

    function clearLogs() {
      logs.innerHTML = '';
    }

    async function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function runTest() {
      clearLogs();
      log('üöÄ Iniciando test de dropdowns...', 'log');
      log('', 'log');

      try {
        // 1. Verificar que estamos en la p√°gina correcta
        log('1Ô∏è‚É£ Verificando entorno...', 'log');

        if (!window.biblioteca) {
          log('‚ùå ERROR: window.biblioteca no est√° disponible', 'error');
          log('‚ö†Ô∏è  Aseg√∫rate de abrir index.html primero', 'warning');
          return;
        }

        log('‚úÖ Biblioteca disponible', 'success');
        await sleep(500);

        // 2. Abrir un libro
        log('', 'log');
        log('2Ô∏è‚É£ Abriendo un libro...', 'log');

        const bookEngine = window.bookEngine;
        if (!bookEngine) {
          log('‚ùå ERROR: BookEngine no disponible', 'error');
          return;
        }

        // Abrir primer libro, primer cap√≠tulo
        const books = bookEngine.books;
        if (!books || books.length === 0) {
          log('‚ùå ERROR: No hay libros disponibles', 'error');
          return;
        }

        const firstBook = books[0];
        log(`‚úÖ Abriendo libro: ${firstBook.title}`, 'success');

        bookEngine.openBook(firstBook.id);
        await sleep(1000);

        const firstChapter = firstBook.sections[0]?.chapters[0];
        if (!firstChapter) {
          log('‚ùå ERROR: No hay cap√≠tulos en el libro', 'error');
          return;
        }

        log(`‚úÖ Abriendo cap√≠tulo: ${firstChapter.title}`, 'success');
        bookEngine.navigateToChapter(firstChapter.id);
        await sleep(2000); // Esperar a que se renderice

        // 3. Verificar que el BookReader est√° activo
        log('', 'log');
        log('3Ô∏è‚É£ Verificando BookReader...', 'log');

        const bookReader = window.bookReader;
        if (!bookReader) {
          log('‚ùå ERROR: BookReader no est√° disponible', 'error');
          return;
        }

        log('‚úÖ BookReader activo', 'success');

        const eventManager = bookReader.events?.eventManager;
        if (!eventManager) {
          log('‚ùå ERROR: EventManager no disponible', 'error');
          return;
        }

        log('‚úÖ EventManager disponible', 'success');
        await sleep(500);

        // 4. Probar dropdowns
        log('', 'log');
        log('4Ô∏è‚É£ Probando dropdowns...', 'log');

        const dropdownTests = [
          { btn: 'tools-dropdown-btn', menu: 'tools-dropdown', name: 'Herramientas' },
          { btn: 'book-features-dropdown-btn', menu: 'book-features-dropdown', name: 'Funcionalidades' },
          { btn: 'settings-dropdown-btn', menu: 'settings-dropdown', name: 'Ajustes' }
        ];

        let passedTests = 0;
        let failedTests = 0;

        for (const test of dropdownTests) {
          log(``, 'log');
          log(`üìã Probando: ${test.name}`, 'log');

          // Verificar bot√≥n
          const btn = document.getElementById(test.btn);
          if (!btn) {
            log(`  ‚ùå Bot√≥n "${test.btn}" NO encontrado en DOM`, 'error');
            failedTests++;
            continue;
          }
          log(`  ‚úÖ Bot√≥n encontrado`, 'success');

          // Verificar men√∫
          const menu = document.getElementById(test.menu);
          if (!menu) {
            log(`  ‚ùå Men√∫ "${test.menu}" NO encontrado en DOM`, 'error');
            failedTests++;
            continue;
          }
          log(`  ‚úÖ Men√∫ encontrado`, 'success');

          // Verificar listener
          const stats = eventManager.getStats();
          const hasListener = stats.byTarget[test.btn] > 0;
          if (!hasListener) {
            log(`  ‚ùå NO tiene listener adjuntado`, 'error');
            failedTests++;
            continue;
          }
          log(`  ‚úÖ Listener adjuntado (${stats.byTarget[test.btn]} eventos)`, 'success');

          // Probar click
          const wasHidden = menu.classList.contains('hidden');
          log(`  üñ±Ô∏è  Estado inicial: ${wasHidden ? 'OCULTO' : 'VISIBLE'}`, 'log');

          btn.click();
          await sleep(100);

          const isHiddenAfterClick = menu.classList.contains('hidden');
          const toggled = wasHidden !== isHiddenAfterClick;

          if (!toggled) {
            log(`  ‚ùå Click NO funcion√≥ (estado no cambi√≥)`, 'error');
            failedTests++;
          } else {
            log(`  ‚úÖ Click funcion√≥ correctamente (ahora ${isHiddenAfterClick ? 'OCULTO' : 'VISIBLE'})`, 'success');
            passedTests++;

            // Cerrar el dropdown
            if (!isHiddenAfterClick) {
              btn.click();
              await sleep(100);
            }
          }
        }

        // 5. Navegar a otro cap√≠tulo
        log('', 'log');
        log('5Ô∏è‚É£ Navegando a otro cap√≠tulo...', 'log');

        const secondChapter = firstBook.sections[0]?.chapters[1] || firstBook.sections[1]?.chapters[0];
        if (!secondChapter) {
          log('‚ö†Ô∏è  No hay segundo cap√≠tulo, saltando prueba de navegaci√≥n', 'warning');
        } else {
          log(`üìñ Navegando a: ${secondChapter.title}`, 'log');
          bookEngine.navigateToChapter(secondChapter.id);
          await sleep(2000); // Esperar a que se renderice con el setTimeout(0)

          log('', 'log');
          log('6Ô∏è‚É£ Re-probando dropdowns despu√©s de navegaci√≥n...', 'log');

          for (const test of dropdownTests) {
            log(``, 'log');
            log(`üìã Re-probando: ${test.name}`, 'log');

            const btn = document.getElementById(test.btn);
            if (!btn) {
              log(`  ‚ùå Bot√≥n "${test.btn}" NO encontrado despu√©s de navegaci√≥n`, 'error');
              failedTests++;
              continue;
            }

            const menu = document.getElementById(test.menu);
            if (!menu) {
              log(`  ‚ùå Men√∫ "${test.menu}" NO encontrado despu√©s de navegaci√≥n`, 'error');
              failedTests++;
              continue;
            }

            const stats = eventManager.getStats();
            const hasListener = stats.byTarget[test.btn] > 0;
            if (!hasListener) {
              log(`  ‚ùå Listener PERDIDO despu√©s de navegaci√≥n`, 'error');
              failedTests++;
              continue;
            }

            // Probar click
            const wasHidden = menu.classList.contains('hidden');
            btn.click();
            await sleep(100);

            const isHiddenAfterClick = menu.classList.contains('hidden');
            const toggled = wasHidden !== isHiddenAfterClick;

            if (!toggled) {
              log(`  ‚ùå Click NO funcion√≥ despu√©s de navegaci√≥n`, 'error');
              failedTests++;
            } else {
              log(`  ‚úÖ Click funcion√≥ despu√©s de navegaci√≥n`, 'success');
              passedTests++;

              if (!isHiddenAfterClick) {
                btn.click();
                await sleep(100);
              }
            }
          }
        }

        // Resumen
        log('', 'log');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'log');
        log('üìä RESUMEN DE TESTS', 'log');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'log');
        log(`‚úÖ Tests exitosos: ${passedTests}`, 'success');
        log(`‚ùå Tests fallidos: ${failedTests}`, failedTests > 0 ? 'error' : 'log');
        log(`üìà Tasa de √©xito: ${Math.round((passedTests / (passedTests + failedTests)) * 100)}%`, passedTests > failedTests ? 'success' : 'error');

        if (failedTests === 0) {
          log('', 'log');
          log('üéâ ¬°TODOS LOS TESTS PASARON!', 'success');
          log('Los dropdowns funcionan correctamente antes y despu√©s de navegar.', 'success');
        } else {
          log('', 'log');
          log('‚ö†Ô∏è  ALGUNOS TESTS FALLARON', 'error');
          log('Los dropdowns NO est√°n funcionando correctamente.', 'error');
        }

      } catch (error) {
        log('', 'log');
        log(`‚ùå ERROR FATAL: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // Auto-ejecutar despu√©s de 2 segundos si estamos en iframe o query param
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('auto') === 'true') {
        setTimeout(() => {
          log('ü§ñ Auto-ejecutando test...', 'log');
          runTest();
        }, 2000);
      }
    });
  </script>
</body>
</html>
