<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Transici√≥n - Colecci√≥n Nuevo Ser</title>
  <meta name="description" content="Explora proyectos y comunidades del Nuevo Ser en un globo 3D interactivo">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Styles -->
  <link rel="stylesheet" href="css/transition-globe.css?v=1.0.0">

  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .tg-action-btn.donate {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    .tg-action-btn.donate:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }
  </style>
</head>
<body class="transition-map-page">
  <!-- Header -->
  <header class="tg-header">
    <div class="tg-header-content">
      <a href="index.html" class="tg-logo">
        <span class="tg-logo-icon">üåç</span>
        <span class="tg-logo-text">Mapa de Transici√≥n</span>
      </a>

      <a href="index.html" class="tg-back-btn">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span>Volver</span>
      </a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="tg-main">
    <!-- Globe Container -->
    <div class="tg-globe-container">
      <div id="transition-globe"></div>

      <!-- Filters Panel -->
      <div class="tg-filters-panel" id="filters-panel">
        <div class="tg-filters-handle" onclick="toggleFilters()"></div>

        <h3 class="tg-filters-title">Filtros</h3>

        <!-- Category Filter -->
        <div class="tg-filter-group">
          <label class="tg-filter-label">Categor√≠a</label>
          <div class="tg-filter-buttons" id="category-filters">
            <!-- Generated by JS -->
          </div>
        </div>

        <!-- Scale Filter -->
        <div class="tg-filter-group">
          <label class="tg-filter-label">Escala</label>
          <div class="tg-filter-buttons" id="scale-filters">
            <button class="tg-filter-btn" data-scale="local" onclick="toggleScaleFilter('local')">
              Local
            </button>
            <button class="tg-filter-btn" data-scale="regional" onclick="toggleScaleFilter('regional')">
              Regional
            </button>
            <button class="tg-filter-btn" data-scale="nacional" onclick="toggleScaleFilter('nacional')">
              Nacional
            </button>
            <button class="tg-filter-btn" data-scale="global" onclick="toggleScaleFilter('global')">
              Global
            </button>
          </div>
        </div>

        <!-- Reset Filters -->
        <button class="tg-filter-btn w-full justify-center mt-2" onclick="resetFilters()">
          <i data-lucide="x" class="w-3 h-3"></i>
          Limpiar filtros
        </button>
      </div>

      <!-- Stats Bar -->
      <div class="tg-stats-bar" id="tg-stats">
        <!-- Updated by JS -->
      </div>

      <!-- Suggest Project Button -->
      <button class="tg-suggest-btn" onclick="openSuggestModal()">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Sugerir Proyecto</span>
      </button>
    </div>

    <!-- Detail Panel -->
    <div class="tg-detail-panel" id="detail-panel">
      <div class="tg-detail-header">
        <div>
          <div class="tg-detail-category" id="detail-category"></div>
          <h2 class="tg-detail-title" id="detail-title"></h2>
          <p class="tg-detail-location" id="detail-location">
            <i data-lucide="map-pin" class="w-4 h-4"></i>
            <span></span>
          </p>
        </div>
        <button class="tg-detail-close" onclick="closeDetailPanel()">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="tg-detail-body">
        <p class="tg-detail-description" id="detail-description"></p>

        <div class="tg-detail-meta" id="detail-meta">
          <!-- Generated by JS -->
        </div>

        <div class="tg-detail-actions" id="detail-actions">
          <!-- Generated by JS -->
        </div>

        <div class="tg-related-books" id="detail-related" style="display:none;">
          <h4 class="tg-related-title">Libros relacionados</h4>
          <div class="tg-related-list" id="related-books-list">
            <!-- Generated by JS -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Suggest Project Modal -->
  <div class="tg-suggest-modal" id="suggest-modal">
    <div class="tg-suggest-content">
      <div class="tg-suggest-header">
        <h3 class="tg-suggest-title">Sugerir un Proyecto</h3>
        <button class="tg-suggest-close" onclick="closeSuggestModal()">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <form class="tg-suggest-body" id="suggest-form" onsubmit="submitSuggestion(event)">
        <div class="tg-form-group">
          <label class="tg-form-label" for="project-name">Nombre del proyecto *</label>
          <input type="text" id="project-name" class="tg-form-input" required placeholder="Ej: Cooperativa Solar del Sur">
        </div>

        <div class="tg-form-group">
          <label class="tg-form-label" for="project-category">Categor√≠a *</label>
          <select id="project-category" class="tg-form-select" required>
            <option value="">Selecciona una categor√≠a</option>
            <option value="economia">Econom√≠a Alternativa</option>
            <option value="gobernanza">Gobernanza Participativa</option>
            <option value="ecologia">Ecolog√≠a & Permacultura</option>
            <option value="educacion">Educaci√≥n Transformadora</option>
            <option value="comunidades">Comunidades Intencionales</option>
            <option value="salud">Salud & Bienestar</option>
            <option value="tecnologia">Tecnolog√≠a Consciente</option>
            <option value="arte">Arte & Cultura</option>
          </select>
        </div>

        <div class="tg-form-group">
          <label class="tg-form-label" for="project-location">Ubicaci√≥n *</label>
          <input type="text" id="project-location" class="tg-form-input" required placeholder="Ej: Barcelona, Espa√±a">
        </div>

        <div class="tg-form-group">
          <label class="tg-form-label" for="project-description">Descripci√≥n *</label>
          <textarea id="project-description" class="tg-form-textarea" required placeholder="Describe brevemente el proyecto y su impacto..."></textarea>
        </div>

        <div class="tg-form-group">
          <label class="tg-form-label" for="project-website">Sitio web</label>
          <input type="url" id="project-website" class="tg-form-input" placeholder="https://ejemplo.com">
          <p class="tg-form-hint">Opcional, pero ayuda a verificar el proyecto</p>
        </div>

        <div class="tg-form-group">
          <label class="tg-form-label" for="submitter-email">Tu email *</label>
          <input type="email" id="submitter-email" class="tg-form-input" required placeholder="tu@email.com">
          <p class="tg-form-hint">Solo para contactarte si necesitamos m√°s informaci√≥n</p>
        </div>
      </form>

      <div class="tg-suggest-footer">
        <button type="button" class="tg-action-btn secondary" onclick="closeSuggestModal()">
          Cancelar
        </button>
        <button type="submit" form="suggest-form" class="tg-action-btn primary">
          <i data-lucide="send" class="w-4 h-4"></i>
          Enviar Sugerencia
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/features/entity-verification-system.js?v=1.0.0"></script>
  <script src="js/features/entity-donation-modal.js?v=2.0.0"></script>
  <script src="js/features/transition-globe.js?v=1.1.0"></script>
  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Categories data (will be loaded from globe)
    let categories = {};
    let globe = null;

    // Store current project for donation
    let currentProject = null;

    // Initialize globe when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      globe = new TransitionGlobe('transition-globe', {
        onProjectSelect: showProjectDetails,
        showDetailsPanel: false // Use our own HTML panel instead
      });

      // Expose globe for the donation modal
      window.transitionGlobe = globe;

      // Load categories for filters
      setTimeout(() => {
        if (globe && globe.categories) {
          categories = globe.categories;
          renderCategoryFilters();
        }
      }, 1000);
    });

    // Render category filter buttons
    function renderCategoryFilters() {
      const container = document.getElementById('category-filters');
      if (!container || !categories) return;

      let html = '';
      for (const [key, cat] of Object.entries(categories)) {
        html += `
          <button class="tg-filter-btn" data-category="${key}" onclick="toggleCategoryFilter('${key}')">
            <span class="tg-category-dot" style="background:${cat.color}"></span>
            ${cat.name.split(' ')[0]}
          </button>
        `;
      }
      container.innerHTML = html;
      lucide.createIcons();
    }

    // Filter functions
    function toggleCategoryFilter(category) {
      const btn = document.querySelector(`[data-category="${category}"]`);
      if (btn) btn.classList.toggle('active');
      if (globe) globe.toggleCategoryFilter(category);
    }

    function toggleScaleFilter(scale) {
      const btn = document.querySelector(`[data-scale="${scale}"]`);
      if (btn) btn.classList.toggle('active');
      if (globe) globe.toggleScaleFilter(scale);
    }

    function resetFilters() {
      document.querySelectorAll('.tg-filter-btn.active').forEach(btn => btn.classList.remove('active'));
      if (globe) {
        globe.filters.categories = [];
        globe.filters.scales = [];
        globe.applyFilters();
      }
    }

    function toggleFilters() {
      document.getElementById('filters-panel').classList.toggle('expanded');
    }

    // Show project details
    function showProjectDetails(project) {
      if (!project) return;

      // Store for donation
      currentProject = project;

      // Update categories from globe if available
      if (globe && globe.categories && Object.keys(globe.categories).length > 0) {
        categories = globe.categories;
      }

      const panel = document.getElementById('detail-panel');
      const category = categories[project.type] || { name: project.type, color: '#10b981' };

      console.log('[TransitionMap] Showing project:', project.name);

      // Category badge
      document.getElementById('detail-category').innerHTML = `
        <span class="tg-category-dot" style="background:${category.color}"></span>
        ${category.name}
      `;
      document.getElementById('detail-category').style.background = `${category.color}20`;
      document.getElementById('detail-category').style.color = category.color;

      // Title and location
      document.getElementById('detail-title').textContent = project.name;
      document.getElementById('detail-location').querySelector('span').textContent = project.location || '';

      // Description
      document.getElementById('detail-description').textContent = project.description;

      // Meta info
      const metaHtml = `
        ${project.founded ? `
          <div class="tg-meta-item">
            <div class="tg-meta-label">Fundado</div>
            <div class="tg-meta-value">${project.founded}</div>
          </div>
        ` : ''}
        ${project.impact ? `
          <div class="tg-meta-item">
            <div class="tg-meta-label">Impacto</div>
            <div class="tg-meta-value">${project.impact}</div>
          </div>
        ` : ''}
        <div class="tg-meta-item">
          <div class="tg-meta-label">Escala</div>
          <div class="tg-meta-value">${getScaleLabel(project.scale)}</div>
        </div>
        <div class="tg-meta-item">
          <div class="tg-meta-label">Verificado</div>
          <div class="tg-meta-value">${project.verified ? '‚úì S√≠' : 'Pendiente'}</div>
        </div>
      `;
      document.getElementById('detail-meta').innerHTML = metaHtml;

      // Actions
      let actionsHtml = `
        <button class="tg-action-btn donate" onclick="openDonationModal()">
          <i data-lucide="heart" class="w-4 h-4"></i>
          Donar
        </button>
      `;
      if (project.website) {
        actionsHtml += `
          <a href="${project.website}" target="_blank" rel="noopener noreferrer" class="tg-action-btn primary">
            <i data-lucide="external-link" class="w-4 h-4"></i>
            Web
          </a>
        `;
      }
      actionsHtml += `
        <button class="tg-action-btn secondary" onclick="shareProject('${project.id}')">
          <i data-lucide="share-2" class="w-4 h-4"></i>
          Compartir
        </button>
      `;
      document.getElementById('detail-actions').innerHTML = actionsHtml;

      // Related books
      const relatedSection = document.getElementById('detail-related');
      const relatedList = document.getElementById('related-books-list');

      if (project.relatedBooks && project.relatedBooks.length > 0) {
        relatedSection.style.display = 'block';
        relatedList.innerHTML = project.relatedBooks.map(bookId => `
          <a href="index.html#book-${bookId}" class="tg-related-book">
            <i data-lucide="book-open" class="w-4 h-4"></i>
            <span>${getBookTitle(bookId)}</span>
          </a>
        `).join('');
      } else {
        relatedSection.style.display = 'none';
      }

      // Show panel
      panel.classList.add('visible');
      lucide.createIcons();
    }

    function closeDetailPanel() {
      document.getElementById('detail-panel').classList.remove('visible');
      currentProject = null;
    }

    // Open donation modal
    function openDonationModal() {
      console.log('[TransitionMap] openDonationModal called');
      console.log('[TransitionMap] currentProject:', currentProject);
      console.log('[TransitionMap] window.entityDonationModal:', window.entityDonationModal);

      if (!currentProject) {
        console.log('[TransitionMap] No currentProject');
        return;
      }

      // Convert project to entity format
      const entity = {
        id: currentProject.id,
        name: currentProject.name,
        category: currentProject.type,
        location: currentProject.location || currentProject.country,
        description: currentProject.description,
        website: currentProject.website,
        btc_address: currentProject.btc_address,
        is_verified: currentProject.verified || false,
        contact_email: currentProject.contact_email
      };

      console.log('[TransitionMap] entity:', entity);

      // Close detail panel
      closeDetailPanel();

      // Open donation modal
      if (window.entityDonationModal) {
        console.log('[TransitionMap] Calling show() on entityDonationModal');
        window.entityDonationModal.show(entity);
      } else {
        alert('Sistema de donaciones no disponible. Recargando...');
        console.error('[TransitionMap] EntityDonationModal NOT available');
        // Try to reload scripts
        setTimeout(() => location.reload(), 1000);
      }
    }

    function getScaleLabel(scale) {
      const labels = {
        local: 'Proyecto Local',
        regional: 'Alcance Regional',
        nacional: 'Escala Nacional',
        global: 'Red Global'
      };
      return labels[scale] || scale;
    }

    function getBookTitle(bookId) {
      const books = {
        'manual-transicion': 'Manual de Transici√≥n',
        'economia-sagrada': 'Econom√≠a Sagrada',
        'ecologia-profunda': 'Ecolog√≠a Profunda',
        'sabiduria-oriental': 'Sabidur√≠a Oriental',
        'meditacion-profunda': 'Meditaci√≥n Profunda',
        'toque-sanacion': 'El Toque de Sanaci√≥n',
        'bienestar-emocional': 'Bienestar Emocional'
      };
      return books[bookId] || bookId;
    }

    function shareProject(projectId) {
      const url = `${window.location.origin}${window.location.pathname}?project=${projectId}`;

      if (navigator.share) {
        navigator.share({
          title: 'Mapa de Transici√≥n',
          text: 'Descubre este proyecto de transici√≥n',
          url: url
        });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url);
        alert('Enlace copiado al portapapeles');
      }
    }

    // Suggest modal functions
    function openSuggestModal() {
      document.getElementById('suggest-modal').classList.add('visible');
    }

    function closeSuggestModal() {
      document.getElementById('suggest-modal').classList.remove('visible');
    }

    function submitSuggestion(event) {
      event.preventDefault();

      const formData = {
        name: document.getElementById('project-name').value,
        category: document.getElementById('project-category').value,
        location: document.getElementById('project-location').value,
        description: document.getElementById('project-description').value,
        website: document.getElementById('project-website').value,
        email: document.getElementById('submitter-email').value,
        timestamp: new Date().toISOString()
      };

      // Store locally (in real implementation, send to server)
      const suggestions = JSON.parse(localStorage.getItem('transition-suggestions') || '[]');
      suggestions.push(formData);
      localStorage.setItem('transition-suggestions', JSON.stringify(suggestions));

      alert('¬°Gracias por tu sugerencia! Revisaremos el proyecto y lo a√±adiremos si cumple los criterios.');

      document.getElementById('suggest-form').reset();
      closeSuggestModal();
    }

    // Handle URL params for direct project links
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      const projectId = params.get('project');

      if (projectId && globe) {
        setTimeout(() => {
          globe.selectProject(projectId);
        }, 2000);
      }
    });
  </script>
</body>
</html>
