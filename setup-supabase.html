<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Supabase - Colecci√≥n Nuevo Ser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .copy-btn {
            transition: all 0.2s;
        }
        .copy-btn:hover {
            transform: scale(1.05);
        }
        .copy-btn.copied {
            background-color: #10b981 !important;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-slate-800 rounded-2xl p-6 sm:p-8 mb-8 shadow-2xl border border-blue-500/20">
            <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                üóÑÔ∏è Configurar Base de Datos Supabase
            </h1>
            <p class="text-slate-300 text-base sm:text-lg">
                Sigue estos pasos para crear las tablas necesarias en tu proyecto Supabase
            </p>
        </div>

        <!-- Status -->
        <div class="bg-red-900/50 border-2 border-red-500 rounded-xl p-4 sm:p-6 mb-8">
            <h2 class="text-lg sm:text-xl font-bold mb-3 flex items-center gap-2">
                <span class="text-2xl pulse">‚ùå</span>
                Errores Detectados
            </h2>
            <div class="space-y-2 text-xs sm:text-sm font-mono">
                <div>‚Ä¢ 406 Not Acceptable - reading_progress</div>
                <div>‚Ä¢ 406 Not Acceptable - achievements</div>
                <div>‚Ä¢ 404 Not Found - bookmarks</div>
            </div>
            <p class="mt-4 text-slate-300 text-sm">
                Estos errores indican que las tablas no existen en tu base de datos Supabase.
            </p>
        </div>

        <!-- Step 1 -->
        <div class="bg-slate-800 rounded-xl p-4 sm:p-6 mb-6 shadow-xl border border-slate-700">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-2xl sm:text-3xl font-bold text-blue-400">1</span>
                <h2 class="text-xl sm:text-2xl font-bold">Abrir SQL Editor</h2>
            </div>
            <p class="text-slate-300 mb-4 text-sm sm:text-base">
                Haz clic en el bot√≥n para abrir el editor SQL de tu proyecto Supabase:
            </p>
            <a href="https://supabase.com/dashboard/project/flxrilsxghiqfsfifxch/sql"
               target="_blank"
               class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition-all transform hover:scale-105 text-sm sm:text-base">
                üöÄ Abrir SQL Editor en Supabase
            </a>
        </div>

        <!-- Step 2 -->
        <div class="bg-slate-800 rounded-xl p-4 sm:p-6 mb-6 shadow-xl border border-slate-700">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-2xl sm:text-3xl font-bold text-purple-400">2</span>
                <h2 class="text-xl sm:text-2xl font-bold">Copiar Script SQL</h2>
            </div>
            <p class="text-slate-300 mb-4 text-sm sm:text-base">
                Copia el script SQL completo para crear todas las tablas:
            </p>
            <div class="relative">
                <button id="copy-sql-btn"
                        class="copy-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-lg mb-2 text-sm sm:text-base">
                    üìã Copiar Script SQL (455 l√≠neas)
                </button>
                <div id="copy-feedback" class="text-center text-green-400 font-semibold hidden py-2">
                    ‚úÖ ¬°Copiado al portapapeles!
                </div>
            </div>
            <details class="mt-4">
                <summary class="text-blue-400 cursor-pointer hover:text-blue-300 text-sm">
                    üëÅÔ∏è Ver preview del script (primeras 30 l√≠neas)
                </summary>
                <pre class="bg-slate-900 p-3 sm:p-4 rounded-lg mt-2 text-xs overflow-x-auto text-slate-300">-- ============================================================================
-- SUPABASE DATABASE SCHEMA COMPLETO v2.8.6
-- Colecci√≥n Nuevo Ser - Todas las tablas necesarias
-- ============================================================================

-- Enable Row Level Security por defecto
ALTER DATABASE postgres SET row_security = on;

-- TABLE: profiles
CREATE TABLE IF NOT EXISTS profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email TEXT NOT NULL,
    display_name TEXT,
    avatar_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- TABLE: reading_progress
CREATE TABLE IF NOT EXISTS reading_progress (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    book_id TEXT NOT NULL,
    chapters_read TEXT[] DEFAULT '{}',
    total_chapters INTEGER DEFAULT 0,
    progress_percentage INTEGER DEFAULT 0,
    last_chapter_id TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, book_id)
);
...</pre>
            </details>
        </div>

        <!-- Step 3 -->
        <div class="bg-slate-800 rounded-xl p-4 sm:p-6 mb-6 shadow-xl border border-slate-700">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-2xl sm:text-3xl font-bold text-amber-400">3</span>
                <h2 class="text-xl sm:text-2xl font-bold">Ejecutar Script</h2>
            </div>
            <ol class="list-decimal list-inside space-y-2 text-slate-300 text-sm sm:text-base">
                <li>Pega el script copiado en el SQL Editor</li>
                <li>Haz clic en el bot√≥n <strong class="text-green-400">"Run"</strong> (esquina inferior derecha)</li>
                <li>Espera a que termine la ejecuci√≥n (~5 segundos)</li>
            </ol>
        </div>

        <!-- Step 4 -->
        <div class="bg-slate-800 rounded-xl p-4 sm:p-6 mb-6 shadow-xl border border-slate-700">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-2xl sm:text-3xl font-bold text-green-400">4</span>
                <h2 class="text-xl sm:text-2xl font-bold">Verificar Creaci√≥n</h2>
            </div>
            <p class="text-slate-300 mb-4 text-sm sm:text-base">
                Deber√≠as ver un mensaje de √©xito y estas 9 tablas creadas:
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-xs sm:text-sm">
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> profiles
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> reading_progress
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> notes
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> achievements
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> bookmarks
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> user_settings
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> reflections
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> action_plans
                </div>
                <div class="bg-slate-900 p-2 sm:p-3 rounded flex items-center gap-2">
                    <span class="text-green-400">‚úÖ</span> koan_history
                </div>
            </div>
        </div>

        <!-- Success -->
        <div class="bg-gradient-to-r from-green-900/50 to-blue-900/50 border-2 border-green-500 rounded-xl p-4 sm:p-6 mb-8">
            <h2 class="text-lg sm:text-xl font-bold mb-3 flex items-center gap-2">
                <span class="text-2xl">üéâ</span>
                ¬°Listo!
            </h2>
            <p class="text-slate-300 text-sm sm:text-base">
                Una vez ejecutado el script, recarga tu aplicaci√≥n web (<kbd class="bg-slate-700 px-2 py-1 rounded">Ctrl+Shift+R</kbd>) y los errores deber√≠an desaparecer.
            </p>
        </div>

        <!-- Quick Links -->
        <div class="bg-slate-800 rounded-xl p-4 sm:p-6 shadow-xl border border-slate-700">
            <h3 class="text-base sm:text-lg font-bold mb-4">üîó Enlaces √ötiles</h3>
            <div class="space-y-2 text-sm">
                <a href="https://supabase.com/dashboard/project/flxrilsxghiqfsfifxch/editor"
                   target="_blank"
                   class="block text-blue-400 hover:text-blue-300 hover:underline">
                    ‚Üí Ver tablas en Table Editor
                </a>
                <a href="https://supabase.com/dashboard/project/flxrilsxghiqfsfifxch/auth/users"
                   target="_blank"
                   class="block text-blue-400 hover:text-blue-300 hover:underline">
                    ‚Üí Ver usuarios autenticados
                </a>
                <a href="https://supabase.com/dashboard/project/flxrilsxghiqfsfifxch/logs"
                   target="_blank"
                   class="block text-blue-400 hover:text-blue-300 hover:underline">
                    ‚Üí Ver logs del proyecto
                </a>
            </div>
        </div>
    </div>

    <script>
        // SQL embebido directamente en el HTML (no requiere servidor)
        const sqlContent = `-- ============================================================================
-- SUPABASE DATABASE SCHEMA COMPLETO v2.8.6
-- Colecci√≥n Nuevo Ser - Todas las tablas necesarias
-- ============================================================================
-- INSTRUCCIONES:
-- 1. Abre https://supabase.com/dashboard/project/flxrilsxghiqfsfifxch/sql
-- 2. Copia y pega TODO este script
-- 3. Ejecuta (Run)
-- 4. Verifica que no haya errores
-- ============================================================================

-- Enable Row Level Security por defecto
ALTER DATABASE postgres SET row_security = on;

-- ============================================================================
-- TABLE: profiles
-- ============================================================================
CREATE TABLE IF NOT EXISTS profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email TEXT NOT NULL,
    display_name TEXT,
    avatar_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own profile" ON profiles;
CREATE POLICY "Users can view own profile"
    ON profiles FOR SELECT
    USING (auth.uid() = id);

DROP POLICY IF EXISTS "Users can update own profile" ON profiles;
CREATE POLICY "Users can update own profile"
    ON profiles FOR UPDATE
    USING (auth.uid() = id);

DROP POLICY IF EXISTS "Users can insert own profile" ON profiles;
CREATE POLICY "Users can insert own profile"
    ON profiles FOR INSERT
    WITH CHECK (auth.uid() = id);

-- ============================================================================
-- TABLE: reading_progress
-- ============================================================================
CREATE TABLE IF NOT EXISTS reading_progress (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    book_id TEXT NOT NULL,
    chapters_read TEXT[] DEFAULT '{}',
    total_chapters INTEGER DEFAULT 0,
    progress_percentage INTEGER DEFAULT 0,
    last_chapter_id TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, book_id)
);

ALTER TABLE reading_progress ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own reading progress" ON reading_progress;
CREATE POLICY "Users can view own reading progress"
    ON reading_progress FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can insert own reading progress" ON reading_progress;
CREATE POLICY "Users can insert own reading progress"
    ON reading_progress FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can update own reading progress" ON reading_progress;
CREATE POLICY "Users can update own reading progress"
    ON reading_progress FOR UPDATE
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can delete own reading progress" ON reading_progress;
CREATE POLICY "Users can delete own reading progress"
    ON reading_progress FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: notes
-- ============================================================================
CREATE TABLE IF NOT EXISTS notes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    note_id TEXT NOT NULL,
    book_id TEXT NOT NULL,
    chapter_id TEXT NOT NULL,
    content TEXT NOT NULL,
    color TEXT DEFAULT '#fbbf24',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, note_id)
);

CREATE INDEX IF NOT EXISTS notes_user_book_idx ON notes(user_id, book_id);
CREATE INDEX IF NOT EXISTS notes_user_chapter_idx ON notes(user_id, chapter_id);

ALTER TABLE notes ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own notes" ON notes;
CREATE POLICY "Users can view own notes"
    ON notes FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can insert own notes" ON notes;
CREATE POLICY "Users can insert own notes"
    ON notes FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can update own notes" ON notes;
CREATE POLICY "Users can update own notes"
    ON notes FOR UPDATE
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can delete own notes" ON notes;
CREATE POLICY "Users can delete own notes"
    ON notes FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: achievements
-- ============================================================================
CREATE TABLE IF NOT EXISTS achievements (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    unlocked_ids TEXT[] DEFAULT '{}',
    stats JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE achievements ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own achievements" ON achievements;
CREATE POLICY "Users can view own achievements"
    ON achievements FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can insert own achievements" ON achievements;
CREATE POLICY "Users can insert own achievements"
    ON achievements FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can update own achievements" ON achievements;
CREATE POLICY "Users can update own achievements"
    ON achievements FOR UPDATE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: bookmarks
-- ============================================================================
CREATE TABLE IF NOT EXISTS bookmarks (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    chapter_id TEXT NOT NULL,
    book_id TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, chapter_id)
);

ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own bookmarks" ON bookmarks;
CREATE POLICY "Users can view own bookmarks"
    ON bookmarks FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can insert own bookmarks" ON bookmarks;
CREATE POLICY "Users can insert own bookmarks"
    ON bookmarks FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can delete own bookmarks" ON bookmarks;
CREATE POLICY "Users can delete own bookmarks"
    ON bookmarks FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: user_settings
-- ============================================================================
CREATE TABLE IF NOT EXISTS user_settings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own settings" ON user_settings;
CREATE POLICY "Users can view own settings"
    ON user_settings FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can insert own settings" ON user_settings;
CREATE POLICY "Users can insert own settings"
    ON user_settings FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can update own settings" ON user_settings;
CREATE POLICY "Users can update own settings"
    ON user_settings FOR UPDATE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: reflections (ACTUALIZADA para v2.8.6)
-- ============================================================================
CREATE TABLE IF NOT EXISTS reflections (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    book_id TEXT NOT NULL,
    chapter_id TEXT NOT NULL,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, book_id, chapter_id)
);

CREATE INDEX IF NOT EXISTS idx_reflections_user_id ON reflections(user_id);
CREATE INDEX IF NOT EXISTS idx_reflections_book_id ON reflections(book_id);
CREATE INDEX IF NOT EXISTS idx_reflections_chapter_id ON reflections(chapter_id);

ALTER TABLE reflections ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Los usuarios pueden ver sus propias reflexiones" ON reflections;
CREATE POLICY "Los usuarios pueden ver sus propias reflexiones"
    ON reflections FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden insertar sus propias reflexiones" ON reflections;
CREATE POLICY "Los usuarios pueden insertar sus propias reflexiones"
    ON reflections FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden actualizar sus propias reflexiones" ON reflections;
CREATE POLICY "Los usuarios pueden actualizar sus propias reflexiones"
    ON reflections FOR UPDATE
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden eliminar sus propias reflexiones" ON reflections;
CREATE POLICY "Los usuarios pueden eliminar sus propias reflexiones"
    ON reflections FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: action_plans (NUEVA en v2.8.6)
-- ============================================================================
CREATE TABLE IF NOT EXISTS action_plans (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    action_id TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending',
    notes TEXT DEFAULT '',
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, action_id)
);

CREATE INDEX IF NOT EXISTS idx_action_plans_user_id ON action_plans(user_id);
CREATE INDEX IF NOT EXISTS idx_action_plans_action_id ON action_plans(action_id);
CREATE INDEX IF NOT EXISTS idx_action_plans_status ON action_plans(status);

ALTER TABLE action_plans ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Los usuarios pueden ver sus propios planes de acci√≥n" ON action_plans;
CREATE POLICY "Los usuarios pueden ver sus propios planes de acci√≥n"
    ON action_plans FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden insertar sus propios planes de acci√≥n" ON action_plans;
CREATE POLICY "Los usuarios pueden insertar sus propios planes de acci√≥n"
    ON action_plans FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden actualizar sus propios planes de acci√≥n" ON action_plans;
CREATE POLICY "Los usuarios pueden actualizar sus propios planes de acci√≥n"
    ON action_plans FOR UPDATE
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden eliminar sus propios planes de acci√≥n" ON action_plans;
CREATE POLICY "Los usuarios pueden eliminar sus propios planes de acci√≥n"
    ON action_plans FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- TABLE: koan_history (NUEVA en v2.8.6)
-- ============================================================================
CREATE TABLE IF NOT EXISTS koan_history (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    koan_id TEXT NOT NULL,
    text TEXT NOT NULL,
    category TEXT DEFAULT 'general',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, koan_id)
);

CREATE INDEX IF NOT EXISTS idx_koan_history_user_id ON koan_history(user_id);
CREATE INDEX IF NOT EXISTS idx_koan_history_created_at ON koan_history(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_koan_history_category ON koan_history(category);

ALTER TABLE koan_history ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Los usuarios pueden ver su propio historial de koans" ON koan_history;
CREATE POLICY "Los usuarios pueden ver su propio historial de koans"
    ON koan_history FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden insertar koans en su historial" ON koan_history;
CREATE POLICY "Los usuarios pueden insertar koans en su historial"
    ON koan_history FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Los usuarios pueden eliminar koans de su historial" ON koan_history;
CREATE POLICY "Los usuarios pueden eliminar koans de su historial"
    ON koan_history FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- FUNCTIONS & TRIGGERS
-- ============================================================================

-- Funci√≥n para actualizar updated_at autom√°ticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers para updated_at
DROP TRIGGER IF EXISTS update_profiles_updated_at ON profiles;
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_reading_progress_updated_at ON reading_progress;
CREATE TRIGGER update_reading_progress_updated_at
    BEFORE UPDATE ON reading_progress
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_notes_updated_at ON notes;
CREATE TRIGGER update_notes_updated_at
    BEFORE UPDATE ON notes
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_achievements_updated_at ON achievements;
CREATE TRIGGER update_achievements_updated_at
    BEFORE UPDATE ON achievements
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_user_settings_updated_at ON user_settings;
CREATE TRIGGER update_user_settings_updated_at
    BEFORE UPDATE ON user_settings
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_reflections_updated_at ON reflections;
CREATE TRIGGER update_reflections_updated_at
    BEFORE UPDATE ON reflections
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_action_plans_updated_at ON action_plans;
CREATE TRIGGER update_action_plans_updated_at
    BEFORE UPDATE ON action_plans
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Funci√≥n para crear perfil autom√°ticamente al registrarse
-- ============================================================================
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, email, display_name)
    VALUES (NEW.id, NEW.email, COALESCE(NEW.raw_user_meta_data->>'display_name', split_part(NEW.email, '@', 1)));
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user();

-- ============================================================================
-- Funci√≥n para eliminar usuario (RPC callable desde JavaScript)
-- ============================================================================
CREATE OR REPLACE FUNCTION delete_user()
RETURNS VOID AS $$
BEGIN
    DELETE FROM auth.users WHERE id = auth.uid();
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- GRANT PERMISSIONS
-- ============================================================================
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA public TO anon, authenticated;

-- ============================================================================
-- VERIFICACI√ìN FINAL
-- ============================================================================
SELECT
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = t.table_name) as columns
FROM information_schema.tables t
WHERE table_schema = 'public'
  AND table_name IN (
    'profiles',
    'reading_progress',
    'notes',
    'achievements',
    'bookmarks',
    'user_settings',
    'reflections',
    'action_plans',
    'koan_history'
  )
ORDER BY table_name;

-- Deber√≠as ver 9 tablas listadas arriba
-- ============================================================================
-- FIN - Schema v2.8.6 creado exitosamente!
-- ============================================================================`;

        console.log('‚úÖ SQL cargado:', sqlContent.split('\\n').length, 'l√≠neas');

        // Bot√≥n copiar SQL
        document.getElementById('copy-sql-btn').addEventListener('click', async () => {
            const btn = document.getElementById('copy-sql-btn');
            const feedback = document.getElementById('copy-feedback');

            try {
                await navigator.clipboard.writeText(sqlContent);

                // Feedback visual
                btn.classList.add('copied');
                btn.innerHTML = '‚úÖ ¬°Copiado!';
                feedback.classList.remove('hidden');

                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = 'üìã Copiar Script SQL (455 l√≠neas)';
                    feedback.classList.add('hidden');
                }, 3000);
            } catch (err) {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = sqlContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    btn.classList.add('copied');
                    btn.innerHTML = '‚úÖ ¬°Copiado!';
                    feedback.classList.remove('hidden');

                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.innerHTML = 'üìã Copiar Script SQL (455 l√≠neas)';
                        feedback.classList.add('hidden');
                    }, 3000);
                } catch (err2) {
                    alert('‚ùå Error al copiar autom√°ticamente. Por favor, copia manualmente el archivo SUPABASE-SCHEMA-COMPLETO-v2.8.6.sql');
                    console.error(err2);
                }

                document.body.removeChild(textArea);
            }
        });
    </script>
</body>
</html>
