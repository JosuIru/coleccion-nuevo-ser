name: Android CI/CD Build

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para obtener commit count

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Run linter
        working-directory: mobile-app
        run: npm run lint

      - name: Run tests
        working-directory: mobile-app
        run: npm test -- --ci --coverage --maxWorkers=2

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: mobile-app/coverage/lcov.info
          flags: mobile
          name: mobile-coverage

  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        working-directory: mobile-app/android
        run: chmod +x gradlew

      - name: Decode keystore
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        working-directory: mobile-app/android/app
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > awakening-release-key.keystore

      - name: Create keystore.properties
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        working-directory: mobile-app/android/app
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > keystore.properties <<EOF
          AWAKENING_RELEASE_STORE_FILE=awakening-release-key.keystore
          AWAKENING_RELEASE_KEY_ALIAS=$KEY_ALIAS
          AWAKENING_RELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD
          AWAKENING_RELEASE_KEY_PASSWORD=$KEY_PASSWORD
          EOF

      - name: Build Release APK
        working-directory: mobile-app/android
        run: ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Build Release AAB (Bundle)
        if: startsWith(github.ref, 'refs/tags/v')
        working-directory: mobile-app/android
        run: ./gradlew bundleRelease --no-daemon --stacktrace

      - name: Sign APK
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        working-directory: mobile-app/android/app/build/outputs/apk/release
        run: |
          echo "APK signed during build process"
          ls -lah

      - name: Rename APKs
        working-directory: mobile-app/android/app/build/outputs/apk/release
        run: |
          VERSION_NAME=$(node -p "require('../../../../package.json').version")
          VERSION_CODE=$(git rev-list --count HEAD)

          for apk in *.apk; do
            if [[ $apk == *"universal"* ]]; then
              mv "$apk" "awakening-protocol-v${VERSION_NAME}-${VERSION_CODE}-universal.apk"
            elif [[ $apk == *"arm64-v8a"* ]]; then
              mv "$apk" "awakening-protocol-v${VERSION_NAME}-${VERSION_CODE}-arm64.apk"
            elif [[ $apk == *"armeabi-v7a"* ]]; then
              mv "$apk" "awakening-protocol-v${VERSION_NAME}-${VERSION_CODE}-arm32.apk"
            elif [[ $apk == *"x86_64"* ]]; then
              mv "$apk" "awakening-protocol-v${VERSION_NAME}-${VERSION_CODE}-x86_64.apk"
            elif [[ $apk == *"x86"* ]]; then
              mv "$apk" "awakening-protocol-v${VERSION_NAME}-${VERSION_CODE}-x86.apk"
            fi
          done

      - name: Get APK file sizes
        working-directory: mobile-app/android/app/build/outputs/apk/release
        run: |
          echo "### APK Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| APK | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          for apk in *.apk; do
            size=$(du -h "$apk" | cut -f1)
            echo "| $apk | $size |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload APKs as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: android-apks
          path: mobile-app/android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload AAB as artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v3
        with:
          name: android-aab
          path: mobile-app/android/app/build/outputs/bundle/release/*.aab
          retention-days: 90

      - name: Upload mapping files
        uses: actions/upload-artifact@v3
        with:
          name: mapping-files
          path: mobile-app/android/app/build/outputs/mapping/release/
          retention-days: 90

      - name: Generate changelog
        id: changelog
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges --max-count=20)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile-app/android/app/build/outputs/apk/release/*.apk
            mobile-app/android/app/build/outputs/bundle/release/*.aab
          body: |
            ## Awakening Protocol ${{ github.ref_name }}

            ### Changelog
            ${{ steps.changelog.outputs.changelog }}

            ### Downloads

            - **Universal APK**: Compatible con todos los dispositivos (mÃ¡s pesado)
            - **ARM64 APK**: Para dispositivos modernos (recomendado)
            - **ARM32 APK**: Para dispositivos antiguos
            - **AAB**: Para subir a Google Play Store

            ### Installation

            1. Download el APK correspondiente a tu dispositivo
            2. Habilita "Instalar apps de fuentes desconocidas"
            3. Instala el APK

            ### Performance Metrics

            - APK Size: < 50 MB (split APKs)
            - Min Android Version: 6.0 (API 23)
            - Target Android Version: 14.0 (API 34)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Sentry of release
        if: startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: awakening-protocol
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          curl -sL https://sentry.io/get-cli/ | bash

          sentry-cli releases new "$VERSION"
          sentry-cli releases set-commits "$VERSION" --auto
          sentry-cli releases files "$VERSION" upload-sourcemaps \
            mobile-app/android/app/build/intermediates/sourcemaps/release
          sentry-cli releases finalize "$VERSION"
          sentry-cli releases deploys "$VERSION" new -e production

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'mobile-app'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK
        uses: actions/download-artifact@v3
        with:
          name: android-apks

      - name: Analyze APK size
        run: |
          echo "### APK Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          UNIVERSAL_APK=$(ls *universal.apk)
          SIZE_MB=$(du -m "$UNIVERSAL_APK" | cut -f1)

          echo "ðŸ“¦ Universal APK Size: ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY

          if [ $SIZE_MB -gt 50 ]; then
            echo "âš ï¸ WARNING: APK size exceeds 50 MB target" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… APK size is within target (< 50 MB)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
