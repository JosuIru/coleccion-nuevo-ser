/**
 * Globe3D.js
 * Globo terráqueo 3D con continentes GeoJSON reales (Natural Earth simplificado)
 * Marcadores de crisis 3D interactivos con selección
 */

import React, { useRef, useCallback, useMemo } from 'react';
import { View, StyleSheet } from 'react-native';
import { WebView } from 'react-native-webview';

const Globe3D = ({
  crises = [],
  onCrisisSelect,
  selectedCrisis,
  style
}) => {
  const webViewRef = useRef(null);

  const crisesJson = useMemo(() => JSON.stringify(crises.map(c => ({
    id: c.id,
    lat: c.lat,
    lon: c.lon,
    urgency: c.urgency,
    type: c.type,
    title: c.title || 'Crisis',
    typeIcon: c.typeIcon || '!'
  }))), [crises]);

  const selectedId = selectedCrisis?.id || '';

  const globeHTML = useMemo(() => `
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: transparent; touch-action: none; }
    canvas { display: block; }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #60a5fa; font-size: 14px; text-align: center; font-family: system-ui; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(96,165,250,0.3); border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loading"><div class="spinner"></div>Cargando globo...</div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // GeoJSON simplificado de Natural Earth - Continentes del mundo
    const worldGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        // NORTH AMERICA
        {"type":"Feature","properties":{"name":"North America"},"geometry":{"type":"Polygon","coordinates":[[[-168.05,65.74],[-166.42,64.69],[-164.37,63.39],[-162.75,62.48],[-160.77,60.48],[-159.37,58.99],[-158.05,56.97],[-156.83,55.67],[-155.58,55.82],[-154.51,56.99],[-153.23,57.97],[-151.88,59.16],[-149.86,59.78],[-147.51,60.31],[-145.71,60.49],[-143.67,59.99],[-141.69,59.87],[-139.06,60.34],[-136.54,59.63],[-134.22,58.22],[-132.18,57.05],[-130.02,55.92],[-127.93,54.57],[-126.42,53.80],[-125.06,52.30],[-124.23,50.54],[-123.94,49.06],[-124.23,48.29],[-124.74,47.97],[-124.65,46.86],[-123.89,46.18],[-124.10,44.82],[-124.36,43.38],[-124.55,42.84],[-124.21,41.99],[-124.00,40.42],[-123.70,39.41],[-122.95,38.11],[-122.40,37.36],[-121.87,36.31],[-120.64,35.14],[-119.63,34.42],[-118.60,33.74],[-117.65,33.05],[-117.12,32.54],[-114.72,32.72],[-111.07,31.33],[-108.21,31.33],[-106.45,31.77],[-104.98,30.64],[-104.40,29.57],[-103.11,28.97],[-102.48,29.76],[-101.44,29.77],[-100.66,28.87],[-99.74,27.41],[-99.11,26.43],[-98.24,26.06],[-97.14,25.97],[-97.38,24.84],[-97.70,23.87],[-97.85,22.88],[-97.56,21.92],[-97.14,20.65],[-96.51,19.89],[-96.29,19.34],[-95.90,18.83],[-94.84,18.56],[-94.43,18.14],[-93.55,18.43],[-92.79,18.52],[-92.05,18.70],[-91.40,18.90],[-90.74,19.28],[-90.53,19.87],[-90.45,20.71],[-90.28,21.00],[-89.60,21.26],[-88.54,21.49],[-87.66,21.46],[-87.05,21.54],[-86.81,21.33],[-86.85,20.85],[-87.38,20.21],[-87.62,19.64],[-87.43,19.47],[-87.59,18.96],[-88.07,18.52],[-88.30,18.50],[-88.49,18.49],[-88.84,17.88],[-89.03,18.00],[-89.15,17.96],[-89.14,17.81],[-89.23,17.55],[-89.05,17.65],[-88.93,17.89],[-88.60,18.09],[-88.52,18.45],[-88.11,18.35],[-87.90,18.47],[-87.79,18.52],[-87.35,18.96],[-86.93,19.79],[-86.29,20.23],[-85.80,21.16],[-85.58,21.90],[-84.99,21.86],[-84.53,21.78],[-84.11,21.89],[-83.60,22.06],[-83.19,22.14],[-82.78,22.07],[-82.51,21.94],[-82.12,21.77],[-81.80,21.80],[-80.47,22.87],[-79.94,23.41],[-79.57,23.75],[-79.12,24.02],[-78.62,24.50],[-78.33,24.58],[-77.93,24.52],[-77.02,24.20],[-76.00,24.33],[-75.14,24.78],[-74.48,25.03],[-73.71,25.03],[-72.98,25.17],[-72.22,25.52],[-71.62,25.83],[-71.17,26.32],[-70.65,27.00],[-70.24,27.71],[-69.91,28.35],[-69.74,29.12],[-69.62,29.95],[-69.65,30.69],[-69.79,31.60],[-70.07,32.72],[-70.41,33.85],[-70.86,34.88],[-71.46,35.95],[-72.15,36.76],[-72.87,37.49],[-73.68,38.24],[-74.51,38.98],[-75.18,39.66],[-75.75,40.34],[-76.14,40.83],[-76.63,41.36],[-77.09,41.86],[-77.64,42.48],[-78.06,42.96],[-78.73,43.63],[-79.17,43.47],[-79.00,43.27],[-78.92,42.97],[-79.05,42.80],[-79.17,42.74],[-79.79,42.54],[-80.52,42.32],[-81.28,42.21],[-82.00,41.97],[-82.69,41.68],[-83.14,41.98],[-83.12,42.08],[-82.90,42.43],[-82.55,42.62],[-82.14,43.57],[-82.55,45.35],[-83.59,45.82],[-83.47,45.99],[-83.62,46.12],[-83.89,46.12],[-84.09,46.28],[-84.14,46.51],[-84.34,46.41],[-84.60,46.44],[-84.76,46.64],[-84.88,46.90],[-85.07,46.97],[-85.26,47.08],[-85.65,47.22],[-86.46,47.55],[-86.56,47.69],[-87.40,47.94],[-88.38,48.30],[-89.27,48.02],[-89.60,48.01],[-90.83,48.27],[-91.64,48.14],[-92.61,48.45],[-93.63,48.61],[-94.33,48.67],[-94.68,48.84],[-94.80,49.00],[-94.95,49.37],[-95.16,49.38],[-95.16,49.00],[-97.23,49.00],[-100.65,49.00],[-104.05,49.00],[-107.05,49.00],[-110.05,49.00],[-116.05,49.00],[-117.03,49.00],[-120.00,49.00],[-122.76,49.00],[-123.12,49.06],[-123.30,49.53],[-124.05,49.93],[-124.86,49.53],[-125.62,49.40],[-126.12,49.68],[-126.56,50.42],[-127.03,50.84],[-127.99,51.71],[-128.12,52.33],[-127.74,52.87],[-127.24,53.40],[-126.57,54.08],[-125.35,54.80],[-124.25,55.17],[-123.51,55.87],[-122.63,56.37],[-121.66,56.85],[-120.85,57.47],[-120.00,58.12],[-118.96,59.00],[-117.65,59.51],[-116.32,59.90],[-115.59,60.26],[-114.52,60.54],[-113.24,60.53],[-112.10,60.60],[-110.73,60.57],[-109.72,60.74],[-109.02,61.14],[-108.22,61.63],[-107.12,62.40],[-106.18,62.93],[-105.18,63.47],[-104.14,63.92],[-103.60,64.04],[-102.82,64.27],[-101.70,64.61],[-100.56,64.79],[-99.51,64.85],[-98.70,65.09],[-97.95,65.63],[-97.50,66.30],[-97.27,67.05],[-97.25,67.71],[-97.44,68.18],[-97.76,68.67],[-98.29,68.93],[-99.11,69.27],[-100.05,69.54],[-101.14,69.59],[-102.11,69.74],[-102.82,69.86],[-103.98,69.98],[-105.03,69.99],[-106.32,69.94],[-107.65,69.87],[-109.03,69.86],[-110.36,69.77],[-112.00,69.69],[-113.68,69.40],[-115.07,69.14],[-116.52,68.84],[-117.73,68.56],[-118.85,68.32],[-119.91,68.29],[-121.10,68.38],[-122.01,68.46],[-122.88,68.79],[-123.67,69.22],[-124.36,69.61],[-124.87,70.00],[-125.20,70.27],[-125.66,70.53],[-127.44,70.38],[-128.14,70.48],[-129.05,70.19],[-130.34,70.24],[-131.20,70.09],[-132.17,69.64],[-133.26,69.54],[-134.19,69.49],[-135.29,69.47],[-136.36,69.13],[-137.23,69.02],[-138.32,69.16],[-139.46,69.41],[-140.53,69.47],[-141.00,69.65],[-141.00,69.00],[-141.00,68.00],[-141.00,65.00],[-141.00,62.00],[-141.00,60.31],[-140.99,60.00],[-139.13,60.35],[-137.45,58.91],[-135.47,59.79],[-134.95,59.28],[-134.27,58.86],[-133.36,58.41],[-132.30,57.69],[-131.24,56.60],[-130.00,55.92],[-129.98,55.29],[-130.54,54.80],[-130.54,54.27],[-129.98,53.28],[-130.04,52.75],[-131.08,52.18],[-131.97,51.67],[-132.25,51.13],[-132.66,50.87],[-133.28,51.17],[-133.54,51.56],[-133.71,52.04],[-133.47,52.33],[-132.88,52.85],[-132.08,52.98],[-131.14,52.56],[-130.13,52.87],[-130.29,53.43],[-130.69,54.04],[-131.01,54.54],[-130.87,55.03],[-131.16,55.70],[-131.87,56.40],[-133.07,57.18],[-134.18,58.14],[-135.36,59.46],[-136.23,59.52],[-137.45,58.91],[-138.52,58.19],[-139.79,57.95],[-141.33,58.05],[-142.16,58.68],[-143.37,59.52],[-144.59,59.80],[-145.93,60.46],[-147.11,60.88],[-148.22,60.67],[-148.02,59.98],[-148.57,59.91],[-149.72,59.71],[-150.61,59.37],[-151.87,59.21],[-152.58,58.93],[-154.02,58.50],[-155.01,58.01],[-156.32,57.42],[-157.91,56.67],[-159.04,55.80],[-160.35,55.39],[-161.37,55.35],[-162.29,55.02],[-163.07,54.66],[-163.71,54.18],[-164.08,54.24],[-164.66,54.40],[-164.93,54.60],[-164.79,54.91],[-163.96,55.06],[-163.28,55.00],[-162.45,55.04],[-161.81,55.89],[-160.56,56.01],[-160.07,56.42],[-158.68,57.02],[-158.46,57.22],[-158.04,57.53],[-157.72,57.57],[-157.55,58.33],[-157.04,58.92],[-158.19,58.62],[-158.52,58.79],[-159.06,58.42],[-159.71,58.93],[-159.98,58.57],[-160.36,59.07],[-161.35,58.67],[-161.97,59.14],[-161.87,59.63],[-162.52,59.99],[-163.82,59.80],[-164.66,60.27],[-165.35,60.51],[-165.35,61.07],[-166.12,61.50],[-165.73,62.07],[-164.92,62.63],[-164.53,63.15],[-164.96,63.25],[-165.48,64.07],[-166.42,64.69],[-166.85,65.09],[-168.05,65.74]]]}},
        // SOUTH AMERICA
        {"type":"Feature","properties":{"name":"South America"},"geometry":{"type":"Polygon","coordinates":[[[-81.71,7.71],[-81.51,7.71],[-81.22,7.62],[-81.06,7.82],[-80.89,8.07],[-80.49,8.09],[-80.12,8.33],[-79.56,8.93],[-79.02,9.00],[-78.50,9.42],[-78.06,9.25],[-77.73,8.95],[-77.35,8.67],[-77.47,8.52],[-77.24,7.93],[-77.43,7.27],[-77.75,7.12],[-77.88,7.22],[-78.21,7.51],[-78.43,8.05],[-78.18,8.32],[-78.44,8.39],[-78.62,8.71],[-79.12,8.99],[-79.56,8.93],[-79.76,8.58],[-80.16,8.33],[-80.38,8.30],[-80.48,8.09],[-80.00,7.55],[-80.28,7.42],[-80.42,7.27],[-80.89,7.22],[-81.06,7.82],[-81.19,7.65],[-81.52,7.71],[-81.71,7.71]],[[-77.90,7.23],[-77.54,7.57],[-77.13,7.93],[-76.84,8.64],[-76.09,9.34],[-75.67,9.44],[-75.66,9.77],[-75.48,10.62],[-74.91,11.08],[-74.41,11.23],[-74.14,11.32],[-73.72,11.12],[-72.99,11.02],[-72.25,11.11],[-71.97,11.66],[-71.33,11.78],[-71.36,11.54],[-71.95,11.42],[-72.24,11.11],[-72.52,10.95],[-72.61,10.82],[-72.88,10.49],[-73.00,9.79],[-73.30,9.15],[-72.78,9.09],[-72.66,8.63],[-72.40,8.41],[-72.36,8.00],[-72.48,7.63],[-72.44,7.42],[-72.20,7.34],[-71.96,6.99],[-70.67,7.09],[-70.09,6.96],[-69.39,6.10],[-68.99,6.21],[-68.27,6.15],[-67.70,6.27],[-67.35,6.10],[-67.48,5.56],[-67.82,5.27],[-67.30,4.40],[-67.52,3.73],[-67.74,3.25],[-67.21,2.39],[-66.88,1.25],[-67.07,1.13],[-67.26,1.72],[-67.54,2.04],[-67.87,1.69],[-69.82,1.72],[-69.80,1.08],[-69.22,0.99],[-70.02,0.54],[-70.02,-0.19],[-69.58,-0.55],[-69.42,-1.12],[-69.18,-1.79],[-69.89,-4.30],[-70.39,-3.77],[-70.69,-3.74],[-70.05,-2.73],[-70.81,-2.26],[-71.41,-2.34],[-71.77,-2.17],[-72.33,-2.43],[-73.07,-2.31],[-73.66,-1.26],[-74.12,-1.00],[-74.44,-0.53],[-75.11,-0.06],[-75.37,-0.15],[-75.80,0.08],[-76.29,0.42],[-76.58,0.26],[-77.42,0.40],[-77.67,0.83],[-77.86,0.81],[-78.86,1.38],[-78.99,1.69],[-78.62,2.52],[-78.18,2.35],[-77.86,2.61],[-77.10,3.84],[-77.50,4.09],[-77.27,4.97],[-77.34,5.53],[-77.47,6.69],[-77.90,7.23]],[[-66.88,1.25],[-66.29,0.82],[-65.56,0.69],[-65.35,1.10],[-64.61,1.33],[-64.20,1.49],[-64.08,1.92],[-63.37,2.20],[-63.42,2.41],[-64.27,2.50],[-64.41,3.13],[-64.37,3.80],[-64.82,4.06],[-64.63,4.15],[-63.89,4.02],[-63.09,3.77],[-62.80,4.01],[-62.09,4.16],[-60.97,4.54],[-60.60,4.92],[-60.73,5.20],[-60.21,5.24],[-59.98,5.01],[-60.11,4.57],[-59.77,4.19],[-59.54,3.96],[-59.82,3.61],[-59.97,2.76],[-59.72,2.25],[-59.65,1.79],[-59.03,1.32],[-58.54,1.27],[-58.43,1.46],[-58.11,1.51],[-57.66,1.68],[-57.34,1.95],[-56.78,1.86],[-56.54,1.90],[-55.99,1.82],[-55.91,2.02],[-56.07,2.22],[-55.97,2.52],[-55.57,2.42],[-55.10,2.52],[-54.52,2.31],[-54.09,2.11],[-53.78,2.38],[-53.56,2.33],[-53.42,2.05],[-52.94,2.12],[-52.56,2.50],[-52.25,3.24],[-51.66,4.16],[-51.32,4.20],[-51.07,3.65],[-50.51,1.90],[-49.97,1.74],[-49.95,1.05],[-50.70,0.22],[-50.39,-0.08],[-48.62,-0.24],[-48.58,-1.24],[-47.82,-0.58],[-46.57,-0.94],[-44.91,-1.55],[-44.42,-2.14],[-44.58,-2.69],[-43.42,-2.38],[-41.47,-2.91],[-39.98,-2.87],[-38.50,-3.70],[-37.22,-4.82],[-36.45,-5.11],[-35.60,-5.15],[-35.24,-5.46],[-34.90,-6.74],[-34.73,-7.34],[-35.13,-9.02],[-35.64,-9.65],[-35.89,-10.09],[-36.10,-10.47],[-36.62,-10.50],[-37.12,-11.05],[-37.69,-12.10],[-38.43,-13.04],[-38.67,-13.06],[-38.95,-13.79],[-38.88,-15.67],[-39.16,-17.21],[-39.27,-17.87],[-39.58,-18.26],[-39.76,-19.60],[-40.77,-20.90],[-40.94,-21.94],[-41.75,-22.37],[-41.99,-22.97],[-43.07,-22.97],[-44.65,-23.35],[-45.35,-23.80],[-46.47,-24.09],[-47.65,-24.89],[-48.50,-25.88],[-48.64,-26.62],[-48.47,-27.18],[-48.66,-28.19],[-48.89,-28.67],[-49.59,-29.22],[-50.70,-30.98],[-51.58,-31.78],[-52.26,-32.24],[-52.71,-33.20],[-53.37,-33.77],[-53.65,-33.20],[-53.21,-32.73],[-53.79,-32.05],[-54.57,-31.49],[-55.60,-30.85],[-55.97,-30.88],[-56.98,-30.11],[-57.63,-30.22],[-56.56,-28.47],[-55.97,-28.08],[-55.29,-27.43],[-54.66,-26.44],[-54.29,-25.59],[-54.63,-25.74],[-54.43,-25.16],[-54.29,-24.57],[-54.29,-24.02],[-54.65,-23.84],[-55.03,-23.95],[-55.52,-23.57],[-55.61,-22.66],[-55.80,-22.36],[-56.47,-22.09],[-56.88,-22.28],[-57.94,-22.09],[-57.87,-20.73],[-58.17,-20.18],[-58.18,-19.87],[-57.73,-19.04],[-57.50,-18.17],[-57.68,-17.62],[-58.39,-17.18],[-58.28,-16.39],[-60.16,-16.26],[-60.54,-15.09],[-60.23,-15.08],[-60.57,-13.91],[-61.08,-13.49],[-61.71,-13.49],[-62.13,-13.20],[-62.76,-13.00],[-63.02,-12.81],[-64.30,-12.46],[-65.40,-11.57],[-65.32,-10.90],[-65.44,-10.51],[-65.29,-9.86],[-66.26,-9.83],[-67.11,-10.31],[-68.40,-11.02],[-68.67,-12.56],[-69.53,-10.95],[-68.79,-9.12],[-67.17,-7.27],[-66.00,-6.83],[-69.19,-4.24],[-70.02,-4.33],[-70.02,-2.73],[-71.36,-2.33],[-72.22,-2.43],[-73.24,-2.15],[-73.66,-1.27],[-74.12,-0.98],[-74.44,-0.53],[-75.11,-0.06],[-75.37,-0.15],[-75.80,0.08],[-76.29,0.42],[-76.58,0.26],[-77.42,0.40],[-77.67,0.83],[-77.86,0.81],[-78.86,1.38],[-78.99,1.69],[-78.62,2.52],[-78.18,2.35],[-77.86,2.61],[-77.10,3.84],[-77.50,4.09],[-77.27,4.97],[-77.34,5.53],[-77.50,6.69],[-77.90,7.23],[-77.54,7.57],[-77.13,7.93],[-76.84,8.64],[-76.09,9.34],[-75.67,9.44],[-75.66,9.77],[-75.48,10.62],[-74.91,11.08],[-74.41,11.23],[-74.14,11.32],[-73.72,11.12],[-72.99,11.02],[-72.25,11.11],[-71.97,11.66],[-71.33,11.78],[-71.36,11.54],[-71.95,11.42],[-72.24,11.11],[-72.52,10.95],[-72.61,10.82],[-72.88,10.49],[-73.00,9.79],[-73.30,9.15],[-72.78,9.09],[-72.66,8.63],[-72.40,8.41],[-72.36,8.00],[-72.48,7.63],[-72.44,7.42],[-72.20,7.34],[-71.96,6.99],[-70.67,7.09],[-70.09,6.96],[-69.39,6.10],[-68.99,6.21],[-68.27,6.15],[-67.70,6.27],[-67.35,6.10],[-67.48,5.56],[-67.82,5.27],[-67.30,4.40],[-67.52,3.73],[-67.74,3.25],[-67.21,2.39],[-66.88,1.25]]]}},
        // EUROPE
        {"type":"Feature","properties":{"name":"Europe"},"geometry":{"type":"Polygon","coordinates":[[[-9.03,41.88],[-8.67,42.13],[-8.49,43.32],[-7.98,43.75],[-6.75,43.57],[-5.41,43.57],[-4.35,43.40],[-3.52,43.46],[-1.90,43.42],[-1.50,43.03],[0.34,42.58],[0.70,42.80],[1.83,42.44],[3.04,42.47],[3.16,42.43],[3.21,42.99],[4.39,43.07],[6.19,43.10],[7.44,43.69],[7.55,44.15],[7.04,44.66],[6.75,45.03],[7.10,45.33],[6.80,45.99],[7.04,45.93],[7.87,45.93],[8.42,46.46],[8.47,46.24],[8.97,46.04],[9.18,46.44],[9.92,46.31],[10.44,46.90],[11.09,46.75],[11.03,46.75],[11.16,46.94],[12.15,47.70],[12.15,47.07],[13.81,48.77],[13.03,49.31],[12.52,49.55],[12.42,49.97],[12.24,50.27],[12.97,50.48],[13.34,50.73],[14.60,50.93],[15.02,51.11],[14.97,51.12],[14.82,50.87],[14.37,51.03],[14.07,51.82],[14.68,52.09],[14.61,52.57],[14.13,52.88],[14.25,53.27],[14.75,54.00],[16.95,54.83],[17.71,54.82],[18.91,54.68],[19.66,54.43],[20.58,54.47],[21.27,55.19],[22.32,55.02],[22.76,54.36],[22.65,54.58],[23.37,54.20],[24.60,53.95],[25.77,54.85],[26.46,55.62],[26.59,55.17],[27.18,55.18],[29.23,55.92],[30.16,55.79],[30.97,55.61],[30.76,55.00],[31.05,54.47],[32.71,54.35],[34.11,54.16],[34.52,53.72],[35.31,53.38],[35.86,53.10],[36.40,53.08],[37.43,53.01],[38.22,53.28],[39.42,52.97],[39.50,52.20],[40.06,51.94],[40.84,51.53],[41.21,51.21],[41.41,50.67],[40.93,50.49],[40.00,49.65],[39.03,49.36],[38.59,49.93],[38.01,49.89],[37.39,50.38],[36.63,50.23],[35.36,50.58],[35.02,51.21],[34.22,51.26],[34.14,51.57],[34.39,51.77],[33.75,52.34],[32.72,52.24],[32.41,52.29],[32.16,52.06],[31.79,52.10],[31.54,52.74],[31.31,53.07],[31.50,53.17],[32.30,53.13],[32.69,53.35],[32.40,53.62],[31.73,53.79],[31.79,54.06],[30.93,55.61],[30.76,55.00],[30.47,55.69],[29.38,55.79],[29.23,55.92],[28.18,56.17],[27.86,56.76],[27.77,57.24],[27.29,57.47],[27.72,57.79],[27.42,58.72],[28.13,59.30],[27.98,59.48],[29.12,60.03],[28.07,60.50],[30.21,61.78],[31.14,62.36],[31.52,62.91],[30.04,63.55],[30.44,64.20],[29.54,64.95],[30.22,65.80],[29.06,66.94],[29.98,67.70],[28.45,68.36],[28.78,69.11],[27.73,70.16],[26.18,69.83],[25.69,69.09],[24.74,68.65],[23.66,68.89],[22.36,68.84],[21.24,69.37],[20.65,69.11],[20.03,69.07],[19.88,68.41],[17.99,68.57],[17.07,69.03],[16.77,68.40],[16.11,67.30],[16.76,66.06],[15.84,65.18],[14.93,64.44],[14.10,64.47],[13.56,64.05],[13.97,64.01],[13.57,63.94],[13.07,63.12],[12.14,61.72],[12.30,60.12],[11.47,59.43],[11.03,58.86],[10.36,59.47],[8.38,58.31],[7.05,58.08],[5.66,58.59],[5.31,59.66],[4.99,61.97],[5.91,62.61],[8.55,63.45],[10.53,64.49],[11.95,65.70],[11.93,66.11],[12.63,66.04],[14.39,67.10],[15.64,67.25],[16.40,67.53],[16.13,68.35],[17.07,69.03],[17.94,68.61],[18.54,69.07],[19.05,69.14],[19.88,68.41],[20.03,69.07],[19.49,69.55],[20.79,70.01],[21.17,70.65],[22.06,71.19],[24.55,71.03],[25.50,70.02],[25.25,69.57],[26.07,69.83],[27.73,70.16],[29.02,69.73],[29.98,69.28],[30.18,70.06],[31.29,70.45],[30.01,70.19],[31.10,69.56],[32.13,69.91],[33.78,69.30],[36.51,69.06],[40.29,67.93],[41.06,67.46],[41.13,66.79],[40.02,66.27],[38.38,66.00],[33.92,66.76],[33.18,66.63],[34.81,65.90],[34.88,65.44],[34.94,64.41],[36.23,64.11],[37.01,63.85],[37.14,64.33],[36.54,64.76],[37.18,65.14],[39.59,64.52],[40.44,64.76],[39.76,65.50],[42.09,66.48],[43.02,66.42],[44.54,66.76],[47.60,66.88],[49.10,67.62],[53.34,69.31],[54.84,68.28],[57.52,68.01],[58.80,68.88],[59.94,68.28],[61.08,68.94],[60.03,69.52],[60.55,69.85],[63.50,69.55],[64.92,69.07],[68.51,68.15],[71.18,66.33],[72.84,66.53],[72.77,67.29],[71.85,67.08],[72.23,67.54],[71.29,67.86],[71.05,68.48],[68.78,68.74],[68.17,69.14],[68.14,69.36],[66.93,69.45],[67.26,69.93],[66.72,70.71],[66.82,71.00],[68.16,71.15],[69.94,70.63],[72.59,69.02],[73.08,67.77],[72.43,66.54],[72.82,66.01],[71.64,66.32],[72.22,66.75],[74.67,67.11],[74.50,68.09],[74.93,68.99],[73.84,69.07],[73.60,69.63],[74.40,70.63],[73.10,71.45],[74.89,72.12],[74.66,72.83],[75.16,72.85],[75.68,72.30],[75.29,71.34],[76.76,71.11],[77.72,71.84],[79.65,72.32],[81.50,71.75],[80.61,72.59],[80.51,73.65],[85.65,73.66],[86.82,73.94],[86.01,74.46],[87.17,75.12],[88.32,75.14],[90.26,75.64],[92.90,75.77],[93.23,74.37],[94.98,74.63],[96.03,74.33],[96.05,73.63],[99.44,72.86],[98.56,72.12],[97.56,72.04],[98.26,71.00],[96.86,70.07],[95.95,69.69],[94.29,69.59],[-172.77,71.65],[-169.24,70.50],[-168.01,70.75],[-165.92,71.14],[-164.56,70.79],[-163.58,70.11],[-162.48,69.86],[-161.01,70.32],[-160.78,70.52],[-160.08,70.63],[-159.01,70.63],[-158.53,70.79],[-157.99,70.75],[-156.26,71.57],[-154.99,71.51],[-154.17,70.80],[-153.18,70.88],[-152.21,70.83],[-152.27,70.60],[-150.74,70.43],[-149.72,70.53],[-147.61,70.21],[-145.69,70.12],[-144.92,69.99],[-143.59,70.15],[-142.07,69.85],[-140.99,69.71],[-140.99,66.00],[-140.99,60.31],[-139.12,60.35],[-137.55,59.11],[-135.48,59.80],[-134.95,59.28],[-134.27,58.86],[-133.36,58.42],[-132.30,57.69],[-131.24,56.60],[-130.00,55.92],[-129.98,55.29],[-130.54,54.80],[-131.08,52.18],[-131.97,51.67],[-132.25,51.13],[-132.70,54.04],[-134.64,58.13],[-135.32,59.50],[-136.23,59.52],[-137.55,59.11],[-138.52,58.19],[-139.79,57.95],[-141.33,58.05],[-141.99,59.99],[-141.00,60.31],[-141.00,66.00],[-140.99,69.71],[-141.00,70.00],[-143.99,70.00],[-145.96,71.18],[-147.78,70.56],[-148.85,70.74],[-151.23,70.42],[-152.56,70.69],[-153.95,70.88],[-155.97,71.10],[-157.88,70.88],[-159.63,70.79],[-161.86,70.63],[-163.83,69.93],[-166.20,68.88],[-167.80,68.35],[-169.58,67.94],[-171.09,67.11],[-171.80,66.91],[180.00,65.07],[180.00,64.98],[179.99,64.97],[178.71,64.53],[177.41,64.61],[178.31,64.07],[178.91,63.25],[179.37,62.98],[179.49,62.57],[179.23,62.30],[177.36,62.52],[174.57,61.77],[173.68,61.65],[172.15,60.95],[170.70,60.34],[170.33,59.88],[168.90,60.57],[166.29,59.79],[165.84,60.16],[164.88,59.73],[163.54,59.87],[163.22,59.21],[162.02,58.24],[162.05,57.84],[163.19,57.62],[163.06,56.16],[162.13,56.12],[161.70,55.29],[162.12,54.85],[160.37,54.34],[160.02,53.20],[158.53,52.96],[158.23,51.94],[156.79,51.01],[156.42,51.70],[155.99,53.16],[155.43,55.38],[155.91,56.77],[156.76,57.36],[156.81,57.83],[158.36,58.06],[160.15,59.31],[161.87,60.34],[163.66,61.14],[164.47,62.55],[163.26,62.47],[162.66,61.64],[160.12,60.54],[-179.00,60.80],[-179.98,65.07],[-168.05,65.74],[-166.42,64.69],[-164.37,63.39],[-162.75,62.48],[-160.77,60.48],[-159.37,58.99],[-158.05,56.97],[-156.83,55.67],[-155.58,55.82],[-154.51,56.99],[-153.23,57.97],[-151.88,59.16],[-149.86,59.78],[-147.51,60.31],[-145.71,60.49],[-143.67,59.99],[-141.69,59.87],[-141.00,60.31],[-140.99,60.00],[-139.13,60.35],[-137.55,59.11],[-135.48,59.80],[-134.64,58.13],[-132.70,54.04],[-132.25,51.13],[-131.97,51.67],[-131.08,52.18],[-130.54,54.80],[-129.98,55.29],[-130.00,55.92],[-131.24,56.60],[-132.30,57.69],[-133.36,58.42],[-134.27,58.86],[-134.95,59.28],[-135.48,59.80],[-137.55,59.11],[-139.12,60.35],[-140.99,60.31],[-140.99,66.00],[-140.99,69.71],[-142.07,69.85],[-143.59,70.15],[-144.92,69.99],[-145.69,70.12],[-147.61,70.21],[-149.72,70.53],[-150.74,70.43],[-152.27,70.60],[-152.21,70.83],[-153.18,70.88],[-154.17,70.80],[-154.99,71.51],[-156.26,71.57],[-157.99,70.75],[-158.53,70.79],[-159.01,70.63],[-160.08,70.63],[-160.78,70.52],[-161.01,70.32],[-162.48,69.86],[-163.58,70.11],[-164.56,70.79],[-165.92,71.14],[-168.01,70.75],[-169.24,70.50],[-172.77,71.65],[94.29,69.59],[94.78,69.07],[94.01,68.99],[93.24,68.47],[90.47,68.10],[90.07,67.67],[89.03,66.97],[88.15,66.76],[87.22,66.38],[86.59,65.91],[85.70,65.77],[85.48,66.49],[84.41,67.15],[83.65,66.99],[82.62,66.43],[81.50,67.47],[79.95,67.48],[78.95,67.59],[77.38,67.95],[76.89,68.07],[76.21,67.83],[75.09,67.58],[74.47,67.10],[72.22,66.75],[71.65,66.31],[72.82,66.01],[72.43,66.54],[73.08,67.77],[72.59,69.02],[69.94,70.63],[68.16,71.15],[66.82,71.00],[66.72,70.71],[67.26,69.93],[66.93,69.45],[68.14,69.36],[68.17,69.14],[68.78,68.74],[71.05,68.48],[71.29,67.86],[72.23,67.54],[71.85,67.08],[72.77,67.29],[72.84,66.53],[71.18,66.33],[68.51,68.15],[64.92,69.07],[63.50,69.55],[60.55,69.85],[60.03,69.52],[61.08,68.94],[59.94,68.28],[58.80,68.88],[57.52,68.01],[54.84,68.28],[53.34,69.31],[49.10,67.62],[47.60,66.88],[44.54,66.76],[43.02,66.42],[42.09,66.48],[39.76,65.50],[40.44,64.76],[39.59,64.52],[37.18,65.14],[36.54,64.76],[37.14,64.33],[37.01,63.85],[36.23,64.11],[34.94,64.41],[34.88,65.44],[34.81,65.90],[33.18,66.63],[33.92,66.76],[38.38,66.00],[40.02,66.27],[41.13,66.79],[41.06,67.46],[40.29,67.93],[36.51,69.06],[33.78,69.30],[32.13,69.91],[31.10,69.56],[30.01,70.19],[31.29,70.45],[30.18,70.06],[28.59,69.78],[29.02,69.73],[27.73,70.16],[26.07,69.83],[25.25,69.57],[25.50,70.02],[24.55,71.03],[22.06,71.19],[21.17,70.65],[20.79,70.01],[19.49,69.55],[20.03,69.07],[19.88,68.41],[18.54,69.07],[19.05,69.14],[20.03,69.07],[20.65,69.11],[21.24,69.37],[22.36,68.84],[23.66,68.89],[24.74,68.65],[25.69,69.09],[26.18,69.83],[27.73,70.16],[28.78,69.11],[28.45,68.36],[29.98,67.70],[29.06,66.94],[30.22,65.80],[29.54,64.95],[30.44,64.20],[30.04,63.55],[31.52,62.91],[31.14,62.36],[30.21,61.78],[28.07,60.50],[27.98,59.48],[28.13,59.30],[27.42,58.72],[27.72,57.79],[27.29,57.47],[27.77,57.24],[27.86,56.76],[28.18,56.17],[29.23,55.92],[29.38,55.79],[30.47,55.69],[30.76,55.00],[30.93,55.61],[31.79,54.06],[31.73,53.79],[32.40,53.62],[32.69,53.35],[32.30,53.13],[31.50,53.17],[31.31,53.07],[31.54,52.74],[31.79,52.10],[32.16,52.06],[32.41,52.29],[32.72,52.24],[33.75,52.34],[34.39,51.77],[34.14,51.57],[34.22,51.26],[35.02,51.21],[35.36,50.58],[36.63,50.23],[37.39,50.38],[38.01,49.89],[38.59,49.93],[39.03,49.36],[40.00,49.65],[40.93,50.49],[41.41,50.67],[41.21,51.21],[40.84,51.53],[40.06,51.94],[39.50,52.20],[39.42,52.97],[38.22,53.28],[37.43,53.01],[36.40,53.08],[35.86,53.10],[35.31,53.38],[34.52,53.72],[34.11,54.16],[32.71,54.35],[31.05,54.47],[30.76,55.00],[30.97,55.61],[30.16,55.79],[29.23,55.92],[27.18,55.18],[26.59,55.17],[26.46,55.62],[25.77,54.85],[24.60,53.95],[23.37,54.20],[22.65,54.58],[22.76,54.36],[22.32,55.02],[21.27,55.19],[20.58,54.47],[19.66,54.43],[18.91,54.68],[17.71,54.82],[16.95,54.83],[14.75,54.00],[14.25,53.27],[14.13,52.88],[14.61,52.57],[14.68,52.09],[14.07,51.82],[14.37,51.03],[14.82,50.87],[14.97,51.12],[15.02,51.11],[14.60,50.93],[13.34,50.73],[12.97,50.48],[12.24,50.27],[12.42,49.97],[12.52,49.55],[13.03,49.31],[13.81,48.77],[12.15,47.07],[12.15,47.70],[11.16,46.94],[11.03,46.75],[11.09,46.75],[10.44,46.90],[9.92,46.31],[9.18,46.44],[8.97,46.04],[8.47,46.24],[8.42,46.46],[7.87,45.93],[7.04,45.93],[6.80,45.99],[7.10,45.33],[6.75,45.03],[7.04,44.66],[7.55,44.15],[7.44,43.69],[6.19,43.10],[4.39,43.07],[3.21,42.99],[3.16,42.43],[3.04,42.47],[1.83,42.44],[0.70,42.80],[0.34,42.58],[-1.50,43.03],[-1.90,43.42],[-3.52,43.46],[-4.35,43.40],[-5.41,43.57],[-6.75,43.57],[-7.98,43.75],[-8.49,43.32],[-8.67,42.13],[-9.03,41.88]]]}},
        // AFRICA
        {"type":"Feature","properties":{"name":"Africa"},"geometry":{"type":"Polygon","coordinates":[[[-17.06,20.99],[-17.02,21.42],[-16.97,21.89],[-14.75,21.50],[-14.63,21.86],[-14.22,22.31],[-13.89,23.69],[-12.50,24.77],[-12.03,26.03],[-11.72,26.10],[-11.39,26.88],[-10.55,26.99],[-10.19,26.86],[-9.74,26.86],[-9.41,27.09],[-8.79,27.12],[-8.82,27.66],[-8.66,27.66],[-8.67,28.84],[-7.66,29.37],[-6.50,29.81],[-5.45,29.96],[-4.37,30.90],[-3.65,30.96],[-3.07,31.72],[-2.62,32.09],[-1.31,32.26],[-1.12,32.65],[-1.19,32.87],[-1.73,33.92],[-1.79,34.53],[-2.17,35.17],[-1.21,35.71],[-0.13,35.89],[0.50,36.30],[1.47,36.61],[3.16,36.78],[4.81,36.87],[5.32,36.72],[6.26,37.11],[7.33,37.12],[8.42,36.95],[8.18,36.52],[8.25,36.43],[8.42,36.41],[8.22,36.43],[8.38,35.48],[8.31,34.86],[7.74,34.25],[7.61,33.34],[8.43,32.75],[8.43,32.51],[9.06,32.10],[9.48,30.31],[9.81,29.42],[9.86,28.96],[9.68,28.14],[9.76,27.69],[9.63,27.14],[9.72,26.51],[9.32,26.09],[9.91,25.37],[9.95,24.94],[10.30,24.38],[10.77,24.56],[11.56,24.10],[12.00,23.47],[8.57,21.57],[5.68,19.60],[4.27,19.16],[3.16,19.06],[3.15,19.69],[1.69,20.38],[1.61,20.56],[-1.55,22.79],[-4.92,24.97],[-8.68,27.29],[-8.67,27.66],[-8.67,28.84],[-7.66,29.37],[-6.50,29.81],[-5.45,29.96],[-4.37,30.90],[-3.65,30.96],[-3.07,31.72],[-2.62,32.09],[-1.31,32.26],[-1.12,32.65],[-1.19,32.87],[-1.73,33.92],[-1.79,34.53],[-2.17,35.17],[-1.21,35.71],[-0.13,35.89],[0.50,36.30],[1.47,36.61],[3.16,36.78],[4.81,36.87],[5.32,36.72],[6.26,37.11],[7.33,37.12],[8.42,36.95],[8.18,36.52],[8.25,36.43],[8.42,36.41],[8.22,36.43],[8.38,35.48],[8.31,34.86],[7.74,34.25],[7.61,33.34],[8.43,32.75],[8.43,32.51],[9.06,32.10],[9.48,30.31],[9.81,29.42],[9.86,28.96],[9.68,28.14],[9.76,27.69],[9.63,27.14],[9.72,26.51],[9.32,26.09],[9.91,25.37],[9.95,24.94],[10.30,24.38],[10.77,24.56],[11.56,24.10],[12.00,23.47],[11.99,23.52],[13.58,23.04],[14.14,22.49],[14.85,22.86],[15.10,21.31],[15.47,21.05],[15.49,20.73],[15.90,20.39],[15.75,19.94],[15.69,19.51],[15.30,17.93],[15.12,16.77],[13.80,15.98],[13.33,15.50],[13.08,14.80],[12.30,14.16],[12.22,14.76],[12.02,15.00],[11.52,15.13],[10.99,15.28],[10.70,15.28],[10.11,15.94],[9.52,15.71],[9.01,16.90],[7.65,17.53],[4.96,18.00],[4.27,19.16],[3.16,19.06],[3.15,19.69],[1.69,20.38],[1.61,20.56],[-1.55,22.79],[-4.92,24.97],[-8.68,27.29],[-8.67,27.66],[-8.82,27.66],[-8.79,27.12],[-9.41,27.09],[-9.74,26.86],[-10.19,26.86],[-10.55,26.99],[-11.39,26.88],[-11.72,26.10],[-12.03,26.03],[-12.50,24.77],[-13.89,23.69],[-14.22,22.31],[-14.63,21.86],[-14.75,21.50],[-16.97,21.89],[-17.02,21.42],[-17.06,20.99]],[[-5.15,14.50],[-5.83,15.08],[-6.82,14.82],[-7.33,14.72],[-7.57,15.44],[-7.94,15.94],[-8.24,16.33],[-8.68,15.60],[-9.19,15.14],[-9.57,15.49],[-10.72,15.33],[-11.30,15.25],[-11.51,15.64],[-12.07,15.71],[-12.19,14.84],[-12.25,14.75],[-12.59,13.71],[-13.22,12.64],[-13.70,12.59],[-14.35,12.08],[-14.56,11.49],[-15.14,11.04],[-15.52,11.78],[-16.33,12.20],[-16.71,12.35],[-17.13,13.18],[-17.63,14.73],[-17.19,14.92],[-16.70,15.62],[-16.46,16.14],[-16.35,16.84],[-15.62,16.37],[-15.14,16.59],[-14.58,16.60],[-14.10,16.30],[-13.44,16.04],[-12.83,15.30],[-12.18,14.62],[-12.08,13.99],[-11.62,13.99],[-11.26,14.32],[-10.57,15.43],[-10.30,15.66],[-9.30,16.09],[-9.00,16.01],[-8.78,15.48],[-8.14,15.63],[-7.47,15.88],[-7.06,14.99],[-6.34,14.72],[-5.85,14.79],[-5.15,14.50]],[[-16.71,12.35],[-17.13,13.18],[-17.63,14.73],[-17.75,14.93],[-17.57,14.75],[-17.42,14.86],[-17.39,14.63],[-17.18,14.92],[-16.83,15.30],[-16.36,15.64],[-16.01,16.53],[-16.31,17.10],[-16.52,16.81],[-16.25,16.65],[-16.00,16.26],[-16.19,15.89],[-16.71,12.35]]]}}
      ]
    };

    let scene, camera, renderer, globe, atmosphere;
    let markersGroup;
    let isDragging = false, previousTouch = null, touchStartTime = 0, touchStartPos = null;
    let rotationVelocity = { x: 0, y: 0 };
    let autoRotate = true;
    let crisisData = ${crisesJson};
    let selectedCrisisId = "${selectedId}";

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 2.5;

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setClearColor(0x000000, 0);
      document.body.appendChild(renderer.domElement);

      createGlobe();
      createAtmosphere();
      createMarkers();
      setupLights();
      setupEventListeners();

      document.getElementById('loading').style.display = 'none';
      animate();
    }

    function createGlobe() {
      const geometry = new THREE.SphereGeometry(1, 96, 96);
      const canvas = document.createElement('canvas');
      canvas.width = 2048;
      canvas.height = 1024;
      const ctx = canvas.getContext('2d');

      // Ocean gradient
      const oceanGrad = ctx.createLinearGradient(0, 0, 0, 1024);
      oceanGrad.addColorStop(0, '#061a2e');
      oceanGrad.addColorStop(0.5, '#0a2847');
      oceanGrad.addColorStop(1, '#061a2e');
      ctx.fillStyle = oceanGrad;
      ctx.fillRect(0, 0, 2048, 1024);

      // Draw continents from GeoJSON
      worldGeoJSON.features.forEach(feature => {
        if (feature.geometry.type === 'Polygon') {
          feature.geometry.coordinates.forEach(ring => {
            drawPolygon(ctx, ring);
          });
        } else if (feature.geometry.type === 'MultiPolygon') {
          feature.geometry.coordinates.forEach(polygon => {
            polygon.forEach(ring => {
              drawPolygon(ctx, ring);
            });
          });
        }
      });

      // Grid
      ctx.strokeStyle = 'rgba(59, 130, 246, 0.1)';
      ctx.lineWidth = 1;
      for (let lon = -180; lon <= 180; lon += 30) {
        ctx.beginPath();
        const x = ((lon + 180) / 360) * 2048;
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 1024);
        ctx.stroke();
      }
      for (let lat = -90; lat <= 90; lat += 30) {
        ctx.beginPath();
        const y = ((90 - lat) / 180) * 1024;
        ctx.moveTo(0, y);
        ctx.lineTo(2048, y);
        ctx.stroke();
      }

      const texture = new THREE.CanvasTexture(canvas);
      const material = new THREE.MeshPhongMaterial({
        map: texture,
        specular: new THREE.Color(0x222244),
        shininess: 5
      });

      globe = new THREE.Mesh(geometry, material);
      scene.add(globe);
    }

    function drawPolygon(ctx, coords) {
      if (!coords || coords.length < 3) return;

      ctx.beginPath();
      let first = true;
      coords.forEach(coord => {
        const x = ((coord[0] + 180) / 360) * 2048;
        const y = ((90 - coord[1]) / 180) * 1024;
        if (first) {
          ctx.moveTo(x, y);
          first = false;
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.closePath();

      // Land fill gradient
      const landGrad = ctx.createLinearGradient(0, 0, 0, 1024);
      landGrad.addColorStop(0, '#1a472a');
      landGrad.addColorStop(0.3, '#1e5631');
      landGrad.addColorStop(0.5, '#2d6a4f');
      landGrad.addColorStop(0.7, '#40916c');
      landGrad.addColorStop(1, '#1b4332');
      ctx.fillStyle = landGrad;
      ctx.fill();

      // Coast glow
      ctx.strokeStyle = '#52b788';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function createAtmosphere() {
      const geometry = new THREE.SphereGeometry(1.06, 64, 64);
      const material = new THREE.ShaderMaterial({
        vertexShader: \`
          varying vec3 vNormal;
          void main() {
            vNormal = normalize(normalMatrix * normal);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        \`,
        fragmentShader: \`
          varying vec3 vNormal;
          void main() {
            float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 2.0);
            gl_FragColor = vec4(0.3, 0.6, 1.0, intensity * 0.5);
          }
        \`,
        blending: THREE.AdditiveBlending,
        side: THREE.BackSide,
        transparent: true
      });
      atmosphere = new THREE.Mesh(geometry, material);
      scene.add(atmosphere);
    }

    function createMarkers() {
      if (markersGroup) scene.remove(markersGroup);
      markersGroup = new THREE.Group();

      crisisData.forEach((crisis, i) => {
        const marker = createCrisisMarker(crisis, i);
        markersGroup.add(marker);
      });

      scene.add(markersGroup);
    }

    function createCrisisMarker(crisis, index) {
      const group = new THREE.Group();
      const pos = latLonToVector3(crisis.lat, crisis.lon, 1.02);

      // Color by urgency
      let color, glowColor;
      if (crisis.urgency >= 8) { color = 0xef4444; glowColor = 0xff6b6b; }
      else if (crisis.urgency >= 6) { color = 0xf97316; glowColor = 0xffa94d; }
      else if (crisis.urgency >= 4) { color = 0xeab308; glowColor = 0xffd43b; }
      else { color = 0x22c55e; glowColor = 0x69db7c; }

      const isSelected = crisis.id === selectedCrisisId;
      const size = 0.03 + (crisis.urgency * 0.005);

      // Main sphere
      const sphereGeo = new THREE.SphereGeometry(size, 24, 24);
      const sphereMat = new THREE.MeshPhongMaterial({
        color: color,
        emissive: color,
        emissiveIntensity: isSelected ? 0.9 : 0.5,
        shininess: 100
      });
      const sphere = new THREE.Mesh(sphereGeo, sphereMat);
      sphere.position.copy(pos);
      sphere.userData = { crisisId: crisis.id, crisis: crisis };
      group.add(sphere);

      // Outer glow
      const glowGeo = new THREE.SphereGeometry(size * 2.5, 16, 16);
      const glowMat = new THREE.MeshBasicMaterial({
        color: glowColor,
        transparent: true,
        opacity: isSelected ? 0.5 : 0.25
      });
      const glow = new THREE.Mesh(glowGeo, glowMat);
      glow.position.copy(pos);
      glow.userData = { isGlow: true };
      group.add(glow);

      // Selection rings
      if (isSelected) {
        for (let i = 0; i < 2; i++) {
          const ringGeo = new THREE.RingGeometry(size * (2.5 + i * 0.8), size * (2.8 + i * 0.8), 32);
          const ringMat = new THREE.MeshBasicMaterial({
            color: 0xffffff,
            transparent: true,
            opacity: 0.6 - i * 0.2,
            side: THREE.DoubleSide
          });
          const ring = new THREE.Mesh(ringGeo, ringMat);
          ring.position.copy(pos);
          ring.lookAt(0, 0, 0);
          ring.userData = { isRing: true, speed: 0.03 + i * 0.01 };
          group.add(ring);
        }
      }

      group.userData = { crisisId: crisis.id };
      return group;
    }

    function latLonToVector3(lat, lon, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);
      return new THREE.Vector3(
        -radius * Math.sin(phi) * Math.cos(theta),
        radius * Math.cos(phi),
        radius * Math.sin(phi) * Math.sin(theta)
      );
    }

    function setupLights() {
      scene.add(new THREE.AmbientLight(0x404060, 0.6));
      const sun = new THREE.DirectionalLight(0xffffff, 1.2);
      sun.position.set(5, 3, 5);
      scene.add(sun);
      const fill = new THREE.DirectionalLight(0x3b82f6, 0.3);
      fill.position.set(-5, -2, -5);
      scene.add(fill);
    }

    function setupEventListeners() {
      const c = renderer.domElement;
      c.addEventListener('touchstart', onTouchStart, { passive: false });
      c.addEventListener('touchmove', onTouchMove, { passive: false });
      c.addEventListener('touchend', onTouchEnd, { passive: false });
      c.addEventListener('mousedown', onMouseDown);
      c.addEventListener('mousemove', onMouseMove);
      c.addEventListener('mouseup', onMouseUp);
      window.addEventListener('resize', onResize);
    }

    function onTouchStart(e) {
      e.preventDefault();
      if (e.touches.length === 1) {
        isDragging = true;
        autoRotate = false;
        touchStartTime = Date.now();
        touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        previousTouch = { ...touchStartPos };
      }
    }

    function onTouchMove(e) {
      e.preventDefault();
      if (isDragging && e.touches.length === 1 && previousTouch) {
        const dx = e.touches[0].clientX - previousTouch.x;
        const dy = e.touches[0].clientY - previousTouch.y;
        globe.rotation.y += dx * 0.006;
        globe.rotation.x += dy * 0.006;
        globe.rotation.x = Math.max(-Math.PI / 2.5, Math.min(Math.PI / 2.5, globe.rotation.x));
        previousTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        rotationVelocity = { x: dx * 0.0002, y: dy * 0.0001 };
      }
    }

    function onTouchEnd(e) {
      const duration = Date.now() - touchStartTime;
      const touch = e.changedTouches[0];
      const dist = touchStartPos ? Math.hypot(touch.clientX - touchStartPos.x, touch.clientY - touchStartPos.y) : 999;

      isDragging = false;
      previousTouch = null;

      // Tap detection
      if (duration < 250 && dist < 15) {
        checkMarkerClick(touch.clientX, touch.clientY);
      }

      setTimeout(() => { if (!isDragging) autoRotate = true; }, 3000);
    }

    function onMouseDown(e) {
      isDragging = true;
      autoRotate = false;
      touchStartTime = Date.now();
      touchStartPos = { x: e.clientX, y: e.clientY };
      previousTouch = { ...touchStartPos };
    }

    function onMouseMove(e) {
      if (isDragging && previousTouch) {
        const dx = e.clientX - previousTouch.x;
        const dy = e.clientY - previousTouch.y;
        globe.rotation.y += dx * 0.006;
        globe.rotation.x += dy * 0.006;
        globe.rotation.x = Math.max(-Math.PI / 2.5, Math.min(Math.PI / 2.5, globe.rotation.x));
        previousTouch = { x: e.clientX, y: e.clientY };
        rotationVelocity = { x: dx * 0.0002, y: 0 };
      }
    }

    function onMouseUp(e) {
      const duration = Date.now() - touchStartTime;
      const dist = touchStartPos ? Math.hypot(e.clientX - touchStartPos.x, e.clientY - touchStartPos.y) : 999;

      isDragging = false;
      previousTouch = null;

      if (duration < 250 && dist < 10) {
        checkMarkerClick(e.clientX, e.clientY);
      }

      setTimeout(() => { if (!isDragging) autoRotate = true; }, 3000);
    }

    function checkMarkerClick(clientX, clientY) {
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2(
        (clientX / window.innerWidth) * 2 - 1,
        -(clientY / window.innerHeight) * 2 + 1
      );
      raycaster.setFromCamera(mouse, camera);

      const targets = [];
      markersGroup.children.forEach(g => {
        g.children.forEach(c => {
          if (c.userData && c.userData.crisisId) targets.push(c);
        });
      });

      const hits = raycaster.intersectObjects(targets, false);
      if (hits.length > 0) {
        const id = hits[0].object.userData.crisisId;
        window.ReactNativeWebView?.postMessage(JSON.stringify({ type: 'crisisSelect', crisisId: id }));
      }
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      const time = Date.now() * 0.001;

      if (autoRotate) {
        globe.rotation.y += 0.001;
      } else {
        globe.rotation.y += rotationVelocity.x;
        rotationVelocity.x *= 0.96;
      }

      markersGroup.rotation.copy(globe.rotation);

      // Animate markers
      markersGroup.children.forEach((g, i) => {
        g.children.forEach(c => {
          if (c.userData.isGlow) {
            const pulse = 1 + Math.sin(time * 3 + i) * 0.3;
            c.scale.set(pulse, pulse, pulse);
          }
          if (c.userData.isRing) {
            c.rotateZ(c.userData.speed);
          }
        });
      });

      renderer.render(scene, camera);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
  `, [crisesJson, selectedId]);

  const handleMessage = useCallback((event) => {
    try {
      const data = JSON.parse(event.nativeEvent.data);
      if (data.type === 'crisisSelect' && onCrisisSelect) {
        const crisis = crises.find(c => c.id === data.crisisId);
        if (crisis) onCrisisSelect(crisis);
      }
    } catch (e) {}
  }, [crises, onCrisisSelect]);

  return (
    <View style={[styles.container, style]}>
      <WebView
        ref={webViewRef}
        source={{ html: globeHTML }}
        style={styles.webview}
        onMessage={handleMessage}
        javaScriptEnabled={true}
        domStorageEnabled={true}
        mixedContentMode="always"
        originWhitelist={['*']}
        scrollEnabled={false}
        bounces={false}
        overScrollMode="never"
        androidLayerType="hardware"
      />
    </View>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: 'transparent', overflow: 'hidden', borderRadius: 12 },
  webview: { flex: 1, backgroundColor: 'transparent' }
});

export default Globe3D;
