// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext {
        buildToolsVersion = "34.0.0"
        minSdkVersion = 21
        compileSdkVersion = 34
        targetSdkVersion = 34
        ndkVersion = "25.1.8937393"
        kotlinVersion = "1.9.22"
        supportLibVersion = "28.0.0"
        playServicesVersion = "18.2.0"
        playServicesLocationVersion = "21.0.1"
    }
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle:8.1.4")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:${kotlinVersion}")
        classpath("com.google.gms:google-services:4.4.0")
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        maven { url "$rootDir/../node_modules/react-native/android" }
        maven { url "$rootDir/../node_modules/jsc-android/dist" }
        maven { url "https://www.jitpack.io" }
    }

    // Resolve react-native dependencies
    configurations.all {
        resolutionStrategy.eachDependency { DependencyResolveDetails details ->
            if (details.requested.group == 'com.facebook.react') {
                if (details.requested.name == 'react-native') {
                    details.useTarget group: 'com.facebook.react', name: 'react-android', version: '0.73.2'
                } else if (details.requested.name == 'react-android' && (details.requested.version == null || details.requested.version.isEmpty() || details.requested.version == '+')) {
                    details.useVersion '0.73.2'
                } else if (details.requested.name == 'hermes-android' && (details.requested.version == null || details.requested.version.isEmpty() || details.requested.version == '+')) {
                    details.useVersion '0.73.2'
                }
            }
        }
    }
}

// Map of project names to their correct namespaces
def namespaceMapping = [
    ':react-native-background-timer': 'com.ocetnik.timer',
    ':react-native-async-storage_async-storage': 'com.reactnativecommunity.asyncstorage',
    ':react-native-community_geolocation': 'com.reactnativecommunity.geolocation',
    ':react-native-community_netinfo': 'com.reactnativecommunity.netinfo',
    ':react-native-gesture-handler': 'com.swmansion.gesturehandler',
    ':react-native-reanimated': 'com.swmansion.reanimated',
    ':react-native-safe-area-context': 'com.th3rdwave.safeareacontext',
    ':react-native-screens': 'com.swmansion.rnscreens',
    ':react-native-svg': 'com.horcrux.svg',
    ':react-native-vector-icons': 'com.oblador.vectoricons',
    ':react-native-maps': 'com.airbnb.android.react.maps',
    ':react-native-paper': 'com.callstack.reactnativepaper',
    ':react-native-push-notification': 'com.dieam.reactnativepushnotification',
    ':react-native-geolocation-service': 'com.agontuk.rn.geolocation',
    ':react-native-firebase_app': 'io.invertase.firebase.app',
    ':react-native-firebase_messaging': 'io.invertase.firebase.messaging',
]

// Apply namespace and buildConfig before evaluation
subprojects { subproject ->
    subproject.plugins.whenPluginAdded { plugin ->
        if (plugin.class.name == 'com.android.build.gradle.LibraryPlugin' ||
            plugin.class.name == 'com.android.build.gradle.AppPlugin') {
            subproject.android {
                buildFeatures {
                    buildConfig = true
                }
                // Set namespace from mapping if available
                def ns = namespaceMapping[subproject.path]
                if (ns != null) {
                    namespace = ns
                }
                // Set JVM compatibility
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_1_8
                    targetCompatibility JavaVersion.VERSION_1_8
                }
            }
        }
        // Configure Kotlin JVM target
        if (plugin.class.name.contains('KotlinAndroid') || plugin.class.name.contains('kotlin')) {
            subproject.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                kotlinOptions {
                    jvmTarget = '1.8'
                }
            }
        }
    }
}
