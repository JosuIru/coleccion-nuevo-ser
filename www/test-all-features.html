<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Completo de Features - v2.9.322</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #00d4ff; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 30px; }
    .section {
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #00d4ff;
    }
    h2 { color: #00d4ff; margin-bottom: 15px; font-size: 1.2em; }
    .test-item {
      background: #0f3460;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .test-name {
      flex: 1;
      font-size: 14px;
    }
    .test-status {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .pending { background: #555; color: #ddd; }
    .testing { background: #ffa500; color: #000; animation: pulse 1s infinite; }
    .pass { background: #00ff00; color: #000; }
    .fail { background: #ff0000; color: #fff; }
    .warning { background: #ffcc00; color: #000; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      background: #00d4ff;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    button:hover { background: #00b8e6; }
    button:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }
    .summary {
      background: #16213e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    .summary-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
    }
    .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
    }
    .error-details {
      background: #2a0e0e;
      border: 1px solid #ff0000;
      border-radius: 4px;
      padding: 10px;
      margin-top: 5px;
      font-size: 12px;
      color: #ffaaaa;
      font-family: monospace;
    }
    .instructions {
      background: #2a2a3e;
      border-left: 4px solid #ffa500;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .instructions h3 {
      color: #ffa500;
      margin-bottom: 10px;
    }
    .instructions ol {
      margin-left: 20px;
    }
    .instructions li {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test Completo de Features</h1>
    <div class="subtitle">Versi√≥n 2.9.322 - Verificaci√≥n exhaustiva de funcionalidades</div>

    <div class="instructions">
      <h3>üìã Instrucciones</h3>
      <ol>
        <li>Abre la aplicaci√≥n en otra pesta√±a (gailu.net o localhost)</li>
        <li>Navega a cualquier libro y abre un cap√≠tulo</li>
        <li>Vuelve a esta pesta√±a y haz clic en "Ejecutar Tests"</li>
        <li>El test verificar√° que todos los elementos y listeners existen</li>
        <li>Despu√©s del test autom√°tico, usa "Test Manual" para verificar clicks reales</li>
      </ol>
    </div>

    <div class="summary">
      <h2>Resumen</h2>
      <div class="summary-stats">
        <div class="stat">
          <div class="stat-value" id="total-tests">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat">
          <div class="stat-value pass" id="passed-tests">0</div>
          <div class="stat-label">Pasados</div>
        </div>
        <div class="stat">
          <div class="stat-value fail" id="failed-tests">0</div>
          <div class="stat-label">Fallidos</div>
        </div>
        <div class="stat">
          <div class="stat-value warning" id="warning-tests">0</div>
          <div class="stat-label">Advertencias</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="run-tests">‚ñ∂Ô∏è Ejecutar Tests</button>
      <button id="run-manual-test">üëÜ Test Manual (Click Real)</button>
      <button id="reset-tests">üîÑ Resetear</button>
    </div>

    <div id="test-sections"></div>
  </div>

  <script>
    // Definici√≥n completa de tests
    const TEST_SUITES = {
      'Desktop - Header Buttons': [
        { name: 'Toggle Sidebar Button', id: 'toggle-sidebar', hasListener: true },
        { name: 'AI Chat Button (Desktop)', id: 'ai-chat-btn', hasListener: true },
        { name: 'AI Chat Button (Tablet)', id: 'ai-chat-btn-tablet', hasListener: true },
        { name: 'AudioReader Button (Desktop)', id: 'audioreader-btn', hasListener: true },
        { name: 'AudioReader Button (Tablet)', id: 'audioreader-btn-tablet', hasListener: true },
        { name: 'Support Button (Desktop)', id: 'support-btn', hasListener: true },
        { name: 'Support Button (Tablet)', id: 'support-btn-tablet', hasListener: true },
        { name: 'Notes Button', id: 'notes-btn', hasListener: true },
      ],
      'Mobile - Header Buttons': [
        { name: 'Bookmark Button (Mobile)', id: 'bookmark-btn-mobile', hasListener: false, onclick: true },
        { name: 'AI Chat Button (Mobile)', id: 'ai-chat-btn-mobile', hasListener: true },
        { name: 'AudioReader Button (Mobile)', id: 'audioreader-btn-mobile', hasListener: true },
        { name: 'Support Button (Mobile)', id: 'support-btn-mobile', hasListener: true },
        { name: 'Mobile Menu Button', id: 'mobile-menu-btn', hasListener: true },
      ],
      'Desktop - Dropdowns': [
        { name: 'Tools Dropdown Button', id: 'tools-dropdown-btn', hasListener: true },
        { name: 'Tools Dropdown Menu', id: 'tools-dropdown', hasListener: false, element: true },
        { name: 'Book Features Dropdown Button', id: 'book-features-dropdown-btn', hasListener: true },
        { name: 'Book Features Dropdown Menu', id: 'book-features-dropdown', hasListener: false, element: true },
        { name: 'Settings Dropdown Button', id: 'settings-dropdown-btn', hasListener: true },
        { name: 'Settings Dropdown Menu', id: 'settings-dropdown', hasListener: false, element: true },
      ],
      'Tools Dropdown - Buttons': [
        { name: 'Chapter Resources', id: 'chapter-resources-btn', hasListener: true },
        { name: 'Summary', id: 'summary-btn', hasListener: true },
        { name: 'Voice Notes', id: 'voice-notes-btn', hasListener: true },
        { name: 'Concept Map', id: 'concept-map-btn', hasListener: true },
        { name: 'Action Plans', id: 'action-plans-btn', hasListener: true },
        { name: 'Achievements', id: 'achievements-btn', hasListener: true },
        { name: 'Learning Paths', id: 'learning-paths-btn-desktop', hasListener: true },
        { name: 'Content Adapter', id: 'content-adapter-btn', hasListener: true },
      ],
      'Book Features Dropdown - Buttons': [
        { name: 'Quiz', id: 'quiz-btn', hasListener: true },
        { name: 'Timeline', id: 'timeline-btn', hasListener: true },
        { name: 'Book Resources', id: 'book-resources-btn', hasListener: true },
        { name: 'Koan', id: 'koan-btn', hasListener: true },
      ],
      'Settings Dropdown - Buttons': [
        { name: 'Settings Modal', id: 'open-settings-modal-btn', hasListener: true },
        { name: 'Help Center', id: 'open-help-center-btn', hasListener: true },
        { name: 'My Account', id: 'my-account-btn', hasListener: true },
        { name: 'Android Download', id: 'android-download-btn', hasListener: true },
        { name: 'Language Selector', id: 'language-selector-btn', hasListener: true },
        { name: 'Theme Toggle', id: 'theme-toggle-btn', hasListener: true },
        { name: 'Premium Edition', id: 'premium-edition-btn', hasListener: true },
        { name: 'Share Chapter', id: 'share-chapter-btn', hasListener: true },
      ],
      'Navigation': [
        { name: 'Previous Chapter Button', id: 'prev-chapter', hasListener: true },
        { name: 'Next Chapter Button', id: 'next-chapter', hasListener: true },
      ],
      'Global Objects': [
        { name: 'window.bookReader', check: () => typeof window.bookReader !== 'undefined' },
        { name: 'window.bookReader.events', check: () => window.bookReader?.events !== undefined },
        { name: 'window.bookReader.events.eventManager', check: () => window.bookReader?.events?.eventManager !== undefined },
        { name: 'EventManager tiene listeners', check: () => {
          const stats = window.bookReader?.events?.eventManager?.getStats?.();
          return stats && stats.totalListeners > 0;
        }},
      ]
    };

    let testResults = {};
    let stats = { total: 0, passed: 0, failed: 0, warnings: 0 };

    function renderTestSections() {
      const container = document.getElementById('test-sections');
      container.innerHTML = '';

      for (const [sectionName, tests] of Object.entries(TEST_SUITES)) {
        const section = document.createElement('div');
        section.className = 'section';

        const title = document.createElement('h2');
        title.textContent = sectionName;
        section.appendChild(title);

        tests.forEach((test, index) => {
          const testId = `${sectionName}-${index}`;
          const item = document.createElement('div');
          item.className = 'test-item';
          item.id = testId;

          const name = document.createElement('div');
          name.className = 'test-name';
          name.textContent = test.name;

          const status = document.createElement('div');
          status.className = 'test-status pending';
          status.textContent = 'Pendiente';

          item.appendChild(name);
          item.appendChild(status);
          section.appendChild(item);

          testResults[testId] = { test, status: 'pending', element: item };
        });

        container.appendChild(section);
      }

      updateStats();
    }

    function updateStats() {
      document.getElementById('total-tests').textContent = stats.total;
      document.getElementById('passed-tests').textContent = stats.passed;
      document.getElementById('failed-tests').textContent = stats.failed;
      document.getElementById('warning-tests').textContent = stats.warnings;
    }

    function setTestStatus(testId, status, message = '') {
      const result = testResults[testId];
      if (!result) return;

      const statusEl = result.element.querySelector('.test-status');
      statusEl.className = `test-status ${status}`;

      // Update stats
      if (result.status === 'pass') stats.passed--;
      if (result.status === 'fail') stats.failed--;
      if (result.status === 'warning') stats.warnings--;

      result.status = status;

      if (status === 'pass') {
        statusEl.textContent = '‚úÖ Pass';
        stats.passed++;
      } else if (status === 'fail') {
        statusEl.textContent = '‚ùå Fail';
        stats.failed++;

        if (message) {
          let errorDiv = result.element.querySelector('.error-details');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-details';
            result.element.appendChild(errorDiv);
          }
          errorDiv.textContent = message;
        }
      } else if (status === 'warning') {
        statusEl.textContent = '‚ö†Ô∏è Warning';
        stats.warnings++;

        if (message) {
          let errorDiv = result.element.querySelector('.error-details');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-details';
            result.element.appendChild(errorDiv);
          }
          errorDiv.textContent = message;
        }
      } else if (status === 'testing') {
        statusEl.textContent = '‚è≥ Testing...';
      }

      updateStats();
    }

    async function runTests() {
      // Reset stats
      stats = { total: 0, passed: 0, failed: 0, warnings: 0 };

      // Count total tests
      for (const tests of Object.values(TEST_SUITES)) {
        stats.total += tests.length;
      }
      updateStats();

      for (const [sectionName, tests] of Object.entries(TEST_SUITES)) {
        for (let i = 0; i < tests.length; i++) {
          const testId = `${sectionName}-${i}`;
          const test = tests[i];

          setTestStatus(testId, 'testing');
          await new Promise(resolve => setTimeout(resolve, 50)); // Small delay for visual effect

          try {
            if (test.check) {
              // Custom check function
              const result = test.check();
              if (result) {
                setTestStatus(testId, 'pass');
              } else {
                setTestStatus(testId, 'fail', 'Check function returned false');
              }
            } else if (test.id) {
              const element = document.getElementById(test.id);

              if (!element) {
                // Element doesn't exist
                if (test.optional) {
                  setTestStatus(testId, 'warning', `Element #${test.id} not found (optional)`);
                } else {
                  setTestStatus(testId, 'fail', `Element #${test.id} not found in DOM`);
                }
                continue;
              }

              // Element exists
              if (!test.hasListener && !test.onclick) {
                // Just checking element exists
                setTestStatus(testId, 'pass');
                continue;
              }

              // Check for onclick attribute
              if (test.onclick) {
                if (element.onclick || element.getAttribute('onclick')) {
                  setTestStatus(testId, 'pass');
                } else {
                  setTestStatus(testId, 'fail', 'No onclick attribute found');
                }
                continue;
              }

              // Check for event listeners
              if (test.hasListener) {
                // Try to check if element has listeners
                const hasListeners = checkElementHasListeners(element);
                if (hasListeners) {
                  setTestStatus(testId, 'pass');
                } else {
                  setTestStatus(testId, 'warning', 'Cannot verify listeners (may still work)');
                }
              }
            }
          } catch (error) {
            setTestStatus(testId, 'fail', `Error: ${error.message}`);
          }
        }
      }
    }

    function checkElementHasListeners(element) {
      // Check EventManager stats
      if (window.bookReader?.events?.eventManager) {
        const stats = window.bookReader.events.eventManager.getStats();
        if (stats.byTarget && stats.byTarget[element.id]) {
          return true;
        }
      }

      // Check for onclick
      if (element.onclick) return true;

      // Check for event listeners (Chrome DevTools API)
      if (window.getEventListeners) {
        const listeners = window.getEventListeners(element);
        return Object.keys(listeners).length > 0;
      }

      // Cannot verify
      return null;
    }

    function resetTests() {
      for (const testId in testResults) {
        setTestStatus(testId, 'pending');
        const errorDiv = testResults[testId].element.querySelector('.error-details');
        if (errorDiv) errorDiv.remove();
      }
      stats = { total: 0, passed: 0, failed: 0, warnings: 0 };
      updateStats();
    }

    function runManualTest() {
      alert('Test Manual:\n\n1. Haz clic en el bot√≥n "Tools" (desktop)\n2. El dropdown debe aparecer\n3. Haz clic en "Resumen del capitulo"\n4. Debe abrirse el modal\n5. Navega a otro cap√≠tulo\n6. Repite los pasos 1-4\n\nSi todo funciona, los listeners est√°n correctamente adjuntados.');
    }

    // Event listeners
    document.getElementById('run-tests').addEventListener('click', runTests);
    document.getElementById('run-manual-test').addEventListener('click', runManualTest);
    document.getElementById('reset-tests').addEventListener('click', resetTests);

    // Initialize
    renderTestSections();
  </script>
</body>
</html>
